---
title: "GoodDataNVStadium"
author: "Isabelle Jensen"
date: "2025-02-20"
output: html_document
---

```{r setup, include=FALSE}



library(tidyverse)
library(readxl)
library(dplyr)
library(readr)
library(tidyr)
library(data.table)
library(knitr)
library(lubridate)
library(janitor)
library(gmodels)
library(gt)
library(kableExtra)
library(ggplot2)

#rm(list = ls())

```


```{r just eligible}

NVEligibleVoters <- read_csv("VoterList.63884.013125094408/VoterList.ElgbVtr.63884.013125094408.csv") 
View(NVEligibleVoters)

ClarkCountyVoters <- NVEligibleVoters %>%
  filter(`Residential County` == "Clark")
colnames(ClarkCountyVoters)


StadiumVoters <- read_excel("AllegiantVotes_2024GeneralElection_VoterIDs (1).xlsx") %>%
  rename(CountyVoterID = ID_Number)  # Standardize column name for merging


StadiumVoters <- StadiumVoters %>%
  mutate(Allegiant_Voter = "Yes")
colnames(StadiumVoters)


StadiumVoters <- StadiumVoters %>%
  mutate(CountyVoterID = as.character(CountyVoterID))

ClarkEligibleStadium <- left_join(ClarkCountyVoters, StadiumVoters, by = c("County Voter ID" = "CountyVoterID"))

ClarkEligibleStadium <- ClarkEligibleStadium %>%
  mutate(Allegiant_Voter = case_when(
    Allegiant_Voter == "Yes" ~ "Yes",  # Keep "Yes" as is
    TRUE ~ "No"  # Replace everything else (including NA) with "No"
  ))

# Check the result
table(ClarkEligibleStadium$Allegiant_Voter)



ClarkEligibleStadium <- ClarkEligibleStadium %>%
  clean_names()
colnames(ClarkEligibleStadium)

CrossTable(ClarkEligibleStadium$party, 
           ClarkEligibleStadium$allegiant_voter, 
           prop.chisq = FALSE, prop.r = TRUE)


glimpse(ClarkEligibleStadium$birth_date)


ClarkEligibleStadium <- ClarkEligibleStadium %>%
  mutate(
    birth_date = mdy(birth_date)  
  )

ClarkEligibleStadium <- ClarkEligibleStadium %>%
  mutate(
    age = as.integer(interval(birth_date, today()) / years(1))  
  )

ClarkEligibleStadium <- ClarkEligibleStadium %>%
  mutate(age_group = cut(age, 
                         breaks = c(18, 25, 35, 45, 55, 65, 75, Inf), 
                         labels = c("18-24", "25-34", "35-44", "45-54", "55-64", "65-74", "75+"), 
                         right = FALSE))

# Check the result
table(ClarkEligibleStadium$age_group)


CrossTable(ClarkEligibleStadium$age_group, 
           ClarkEligibleStadium$allegiant_voter, 
           prop.chisq = FALSE, prop.r = TRUE)

```

Cell Contents
|-------------------------|
|                       N |
|           N / Row Total |
|           N / Col Total |
|         N / Table Total |
|-------------------------|

 
Total Observations in Table:  1642136 

 
                           | ClarkEligibleStadium$allegiant_voter 
ClarkEligibleStadium$party |        No |       Yes | Row Total | 
---------------------------|-----------|-----------|-----------|
                  Democrat |    515448 |      1373 |    516821 | 
                           |     0.997 |     0.003 |     0.315 | 
                           |     0.315 |     0.327 |           | 
                           |     0.314 |     0.001 |           | 
---------------------------|-----------|-----------|-----------|
Independent American Party |     71496 |       165 |     71661 | 
                           |     0.998 |     0.002 |     0.044 | 
                           |     0.044 |     0.039 |           | 
                           |     0.044 |     0.000 |           | 
---------------------------|-----------|-----------|-----------|
         Libertarian Party |     11577 |        42 |     11619 | 
                           |     0.996 |     0.004 |     0.007 | 
                           |     0.007 |     0.010 |           | 
                           |     0.007 |     0.000 |           | 
---------------------------|-----------|-----------|-----------|
      Nevada Forward Party |        36 |         0 |        36 | 
                           |     1.000 |     0.000 |     0.000 | 
                           |     0.000 |     0.000 |           | 
                           |     0.000 |     0.000 |           | 
---------------------------|-----------|-----------|-----------|
        Nevada Green Party |      1461 |         3 |      1464 | 
                           |     0.998 |     0.002 |     0.001 | 
                           |     0.001 |     0.001 |           | 
                           |     0.001 |     0.000 |           | 
---------------------------|-----------|-----------|-----------|
Nevada Transhumanist Party |         4 |         0 |         4 | 
                           |     1.000 |     0.000 |     0.000 | 
                           |     0.000 |     0.000 |           | 
                           |     0.000 |     0.000 |           | 
---------------------------|-----------|-----------|-----------|
          No Labels Nevada |       619 |         5 |       624 | 
                           |     0.992 |     0.008 |     0.000 | 
                           |     0.000 |     0.001 |           | 
                           |     0.000 |     0.000 |           | 
---------------------------|-----------|-----------|-----------|
              Non-Partisan |    594759 |      1522 |    596281 | 
                           |     0.997 |     0.003 |     0.363 | 
                           |     0.363 |     0.362 |           | 
                           |     0.362 |     0.001 |           | 
---------------------------|-----------|-----------|-----------|
        Other (All Others) |     29733 |        69 |     29802 | 
                           |     0.998 |     0.002 |     0.018 | 
                           |     0.018 |     0.016 |           | 
                           |     0.018 |     0.000 |           | 
---------------------------|-----------|-----------|-----------|
                Republican |    412801 |      1023 |    413824 | 
                           |     0.998 |     0.002 |     0.252 | 
                           |     0.252 |     0.243 |           | 
                           |     0.251 |     0.001 |           | 
---------------------------|-----------|-----------|-----------|
              Column Total |   1637934 |      4202 |   1642136 | 
                           |     0.997 |     0.003 |           | 
---------------------------|-----------|-----------|-----------|




 Cell Contents
|-------------------------|
|                       N |
|           N / Row Total |
|           N / Col Total |
|         N / Table Total |
|-------------------------|

 
Total Observations in Table:  1642136 

 
                               | ClarkEligibleStadium$allegiant_voter 
ClarkEligibleStadium$age_group |        No |       Yes | Row Total | 
-------------------------------|-----------|-----------|-----------|
                         18-24 |    183883 |       462 |    184345 | 
                               |     0.997 |     0.003 |     0.112 | 
                               |     0.112 |     0.110 |           | 
                               |     0.112 |     0.000 |           | 
-------------------------------|-----------|-----------|-----------|
                         25-34 |    311664 |      1114 |    312778 | 
                               |     0.996 |     0.004 |     0.190 | 
                               |     0.190 |     0.265 |           | 
                               |     0.190 |     0.001 |           | 
-------------------------------|-----------|-----------|-----------|
                         35-44 |    290601 |      1124 |    291725 | 
                               |     0.996 |     0.004 |     0.178 | 
                               |     0.177 |     0.267 |           | 
                               |     0.177 |     0.001 |           | 
-------------------------------|-----------|-----------|-----------|
                         45-54 |    248605 |       779 |    249384 | 
                               |     0.997 |     0.003 |     0.152 | 
                               |     0.152 |     0.185 |           | 
                               |     0.151 |     0.000 |           | 
-------------------------------|-----------|-----------|-----------|
                         55-64 |    245476 |       489 |    245965 | 
                               |     0.998 |     0.002 |     0.150 | 
                               |     0.150 |     0.116 |           | 
                               |     0.149 |     0.000 |           | 
-------------------------------|-----------|-----------|-----------|
                         65-74 |    204309 |       192 |    204501 | 
                               |     0.999 |     0.001 |     0.125 | 
                               |     0.125 |     0.046 |           | 
                               |     0.124 |     0.000 |           | 
-------------------------------|-----------|-----------|-----------|
                           75+ |    153396 |        42 |    153438 | 
                               |     1.000 |     0.000 |     0.093 | 
                               |     0.094 |     0.010 |           | 
                               |     0.093 |     0.000 |           | 
-------------------------------|-----------|-----------|-----------|
                  Column Total |   1637934 |      4202 |   1642136 | 
                               |     0.997 |     0.003 |           | 
-------------------------------|-----------|-----------|-----------|



```{r history}
NVVoteHistory <- read_csv("VoterList.63884.013125094408/VoterList.VtHst.63884.013125094408.csv")  # Load vote history later



```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.


```{r file mike sent}


AllClarkCountyWide <- read_delim("ClarkCo_Nov2024 csv.csv", delim = "\t", col_types = cols(.default = "c"))

glimpse(AllClarkCountyWide)
View(AllClarkCountyWide)

AllClarkCountyWide$allegiant <- ifelse(is.na(AllClarkCountyWide$allegiant), 0, 1)





# Filter for those who voted in Nov 2024
AllClarkCountyWide2024vote <- AllClarkCountyWide %>% filter(!is.na(votecode59))

# Tabulate age categories by allegiant status
table_age <- AllClarkCountyWide2024vote %>%
  group_by(agecat, allegiant) %>%
  summarise(count = n(), .groups = "drop") %>%
  mutate(percent = count / sum(count) * 100)

# Display table
table_age %>%
  tidyr::pivot_wider(names_from = allegiant, values_from = c(count, percent))

age_table <- AllClarkCountyWide2024vote %>%
  tabyl(agecat, allegiant) %>%
  adorn_totals("row") %>%
  adorn_totals("col") %>%
  adorn_percentages("col") %>%
  adorn_pct_formatting(digits = 2) %>%
  adorn_ns()  # Show counts and percentages
print(age_table)


# Summary statistics for numtimesvoted_beforeNov2024 among allegiant voters
summary(AllClarkCountyWide2024vote$numtimesvoted_beforeNov2024[AllClarkCountyWide2024vote$allegiant == 1])

# Summary statistics for numtimesvoted_beforeNov2024 among non-allegiant voters who didn't use votemethod2024 == 8
summary(AllClarkCountyWide2024vote$numtimesvoted_beforeNov2024[AllClarkCountyWide2024vote$allegiant != 1 & AllClarkCountyWide2024vote$votemethod2024 != 8])

# Tabulate numtimesvoted_beforeNov2024 by allegiant status for those who didn't use votemethod2024 == 8
table_voting <- AllClarkCountyWide2024vote %>%
  filter(votemethod2024 != 8) %>%
  group_by(numtimesvoted_beforeNov2024, allegiant) %>%
  summarise(count = n(), .groups = "drop") %>%
  mutate(percent = count / sum(count) * 100) %>%
  arrange(numtimesvoted_beforeNov2024)  # Ensure sorting by the number of times voted

# Display table
table_voting %>%
  tidyr::pivot_wider(names_from = allegiant, values_from = c(count, percent))



AllClarkCountyWide2024vote <- AllClarkCountyWide2024vote %>%
  mutate(numtimesvoted_beforeNov2024 = as.numeric(as.character(numtimesvoted_beforeNov2024)))




votecount_table <- AllClarkCountyWide2024vote %>%
  tabyl(numtimesvoted_beforeNov2024, allegiant) %>%
  adorn_totals("row") %>%
  adorn_totals("col") %>%
  adorn_percentages("col") %>%
  adorn_pct_formatting(digits = 2) %>%
  adorn_ns()  # Show counts and percentages
print(votecount_table)

votecount_table <- AllClarkCountyWide %>%
  tabyl(numtimesvoted_beforeNov2024, allegiant) %>%
  adorn_totals("row") %>%
  adorn_totals("col") %>%
  adorn_percentages("col") %>%
  adorn_pct_formatting(digits = 2) %>%
  adorn_ns()  # Show counts and percentages
print(votecount_table)




```

agecat                   0               1               Total
      1   9.07%    (92,932)  11.71%   (492)   9.08%    (93,424)
      2   6.91%    (70,793)  12.90%   (542)   6.94%    (71,335)
      3  15.80%   (161,878)  27.46% (1,154)  15.85%   (163,032)
      4  16.11%   (164,973)  23.11%   (971)  16.13%   (165,944)
      5  25.74%   (263,647)  19.47%   (818)  25.71%   (264,465)
      6  26.37%   (270,063)   5.35%   (225)  26.28%   (270,288)
  Total 100.00% (1,024,286) 100.00% (4,202) 100.00% (1,028,488)



 numtimesvoted_beforeNov2024                   0               1               Total
                           0  20.00%   (204,859)  35.34% (1,485)  20.06%   (206,344)
                           1  12.74%   (130,522)  20.20%   (849)  12.77%   (131,371)
                           2  10.85%   (111,175)  11.71%   (492)  10.86%   (111,667)
                           3   8.98%    (92,027)   8.90%   (374)   8.98%    (92,401)
                           4   8.52%    (87,255)   7.09%   (298)   8.51%    (87,553)
                           5   7.34%    (75,231)   4.81%   (202)   7.33%    (75,433)
                           6   6.62%    (67,797)   3.97%   (167)   6.61%    (67,964)
                           7   5.69%    (58,313)   2.71%   (114)   5.68%    (58,427)
                           8   4.40%    (45,111)   1.55%    (65)   4.39%    (45,176)
                           9   3.43%    (35,136)   0.98%    (41)   3.42%    (35,177)
                          10   2.75%    (28,118)   0.81%    (34)   2.74%    (28,152)
                          11   2.25%    (23,058)   0.50%    (21)   2.24%    (23,079)
                          12   1.95%    (19,994)   0.50%    (21)   1.95%    (20,015)
                          13   1.69%    (17,325)   0.38%    (16)   1.69%    (17,341)
                          14   1.56%    (15,974)   0.36%    (15)   1.55%    (15,989)
                          15   1.17%    (11,937)   0.19%     (8)   1.16%    (11,945)
                          16   0.04%       (454)   0.00%     (0)   0.04%       (454)
                       Total 100.00% (1,024,286) 100.00% (4,202) 100.00% (1,028,488)





```{r more analysis}

table(AllClarkCountyWide$agecat, AllClarkCountyWide$allegiant)
prop.table(table(AllClarkCountyWide$agecat, AllClarkCountyWide$allegiant), margin = 2)  # Column percentages
glimpse(AllClarkCountyWide$agecat)


summary(AllClarkCountyWide$numtimesvoted_beforeNov2024[AllClarkCountyWide$allegiant == 1])

summary(AllClarkCountyWide$numtimesvoted_beforeNov2024[AllClarkCountyWide$allegiant == 0 & AllClarkCountyWide$votemethod2024 != 8])


table(AllClarkCountyWide$numtimesvoted_beforeNov2024[AllClarkCountyWide$votemethod2024 != 8], AllClarkCountyWide$allegiant[AllClarkCountyWide$votemethod2024 != 8])

prop.table(table(AllClarkCountyWide$numtimesvoted_beforeNov2024[AllClarkCountyWide$votemethod2024 != 8], AllClarkCountyWide$allegiant[AllClarkCountyWide$votemethod2024 != 8]), margin = 2)





AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(
    dateofbirth = mdy(birthdate),
    age11052024 = as.numeric(difftime(ymd("2024-11-05"), dateofbirth, units = "days") / 365.25),
    ageEDay = floor(age11052024)
  ) %>%
  filter(ageEDay >= 18)  # Drop those under 18

# Create age categories
AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(
    agecat = case_when(
      ageEDay >= 18 & ageEDay <= 24 ~ 1,
      ageEDay >= 25 & ageEDay <= 29 ~ 2,
      ageEDay >= 30 & ageEDay <= 39 ~ 3,
      ageEDay >= 40 & ageEDay <= 49 ~ 4,
      ageEDay >= 50 & ageEDay <= 64 ~ 5,
      ageEDay >= 65 ~ 6
    )
  )

# Convert registration date and compute registration length
AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(
    regdate = mdy(registrationdate),
    reg_length = as.numeric(difftime(ymd("2024-11-05"), regdate, units = "days") / 365.25),
    regcat = case_when(
      reg_length <= -0.24 & reg_length > -0.071 ~ -2,
      reg_length <= -0.07 & reg_length > -0.002 ~ -1,
      reg_length == 0 ~ 0,
      reg_length > 0 & reg_length <= 0.096 ~ 1,
      reg_length > 0.096 & reg_length <= 0.178 ~ 2,
      reg_length > 0.178 & reg_length <= 0.846 ~ 3,
      reg_length > 0.847 ~ 4
    )
  )

# Define voting method variable for Nov 2024
AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(
    votemethod2024 = case_when(
      is.na(votecode59) & allegiant == 1 ~ 1,
      votecode59 == "PV" & allegiant == 1 ~ 2,
      votecode59 == "PP" & allegiant == 1 ~ 3,
      votecode59 == "PV" & allegiant != 1 ~ 4,
      votecode59 == "PP" & allegiant != 1 ~ 5,
      votecode59 == "MB" ~ 6,
      votecode59 == "EV" ~ 7,
      is.na(votecode59) & allegiant != 1 ~ 8
    )
  )

# Count elections voted in
vote_columns <- paste0("votecode", 41:58)  # Only considering from 2010 onwards

#this took too long didnt run it
AllClarkCountyWide <- AllClarkCountyWide %>%
  rowwise() %>%
  mutate(
    numtimesvoted_beforeNov2024 = sum(!is.na(c_across(all_of(vote_columns)))),
    numtimesvoted_beforeFeb2024 = sum(!is.na(c_across(all_of(vote_columns[1:16])))),  # Excluding 2024 elections
    voted2020_not2022 = ifelse(!is.na(votecode52) & is.na(votecode55), 1, 0)
  ) %>%
  ungroup()


# Summary statistics
summary_table <- AllClarkCountyWide %>%
  group_by(allegiant, numtimesvoted_beforeNov2024) %>%
  summarise(count = n(), .groups = "drop")


# Display summary tables
print(summary_table)




# Ensure numtimesvoted_beforeNov2024 is numeric
AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(numtimesvoted_beforeNov2024 = as.numeric(numtimesvoted_beforeNov2024))

# Crosstab for Number of Times Voted by Allegiant Status, sorted numerically
vote_history_table <- AllClarkCountyWide %>%
  arrange(numtimesvoted_beforeNov2024) %>%  # Sort the data numerically
  tabyl(numtimesvoted_beforeNov2024, allegiant) %>%  # Create crosstab
  adorn_totals("row") %>%      # Add total row
  adorn_totals("col") %>%      # Add total column
  adorn_percentages("col") %>% # Convert to column percentages
  adorn_pct_formatting(digits = 2) %>%  # Format percentages
  adorn_ns()  # Show both counts and percentages

# Print the sorted table
print(vote_history_table)


# Convert to gt table for better readability
vote_history_table %>%
  gt() %>%
  tab_options(
    table.font.size = "medium",
    heading.title.font.size = "large"
  ) %>%
  cols_label(
    numtimesvoted_beforeNov2024 = "Times Voted",
    `0` = "Non-Allegiant",
    `1` = "Allegiant",
    `Total` = "Total"
  ) %>%
  fmt_number(columns = everything(), decimals = 0)




# Save as a PDF
gtsave(vote_history_table %>% gt(), "vote_history_table.pdf")




# Ensure age category is numeric for sorting
AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(agecat = as.numeric(agecat))

# Create the age category crosstab
age_table <- AllClarkCountyWide %>%
  tabyl(agecat, allegiant) %>%  # Crosstab
  adorn_totals("row") %>%      # Add total row
  adorn_totals("col") %>%      # Add total column
  adorn_percentages("col") %>% # Convert to column percentages
  adorn_pct_formatting(digits = 2) %>%  # Format percentages
  adorn_ns()  # Show both counts and percentages

# Print the table
print(age_table)
age_table %>%
  gt() %>%
  tab_options(
    table.font.size = "medium",
    heading.title.font.size = "large"
  ) %>%
  cols_label(
    agecat = "Age Category",
    `0` = "Non-Allegiant",
    `1` = "Allegiant",
    `Total` = "Total"
  )


gtsave(age_table %>% gt(), "age_table.pdf")




library(dplyr)
library(janitor)
library(gt)

# Ensure party is a factor with the correct order
AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(party = factor(party, levels = c(
    "Democrat", 
    "Republican", 
    "Non-Partisan", 
    "Independent American Party", 
    "Libertarian Party", 
    "Nevada Forward Party",
    "Nevada Green Party",
    "Nevada Transhumanist Party",
    "No Labels Nevada",
    "Other (All Others)"
  )))

# Create the crosstab for Party Affiliation
party_table <- AllClarkCountyWide %>%
  tabyl(party, allegiant) %>%
  adorn_totals("row") %>%
  adorn_totals("col") %>%
  adorn_percentages("col") %>%
  adorn_pct_formatting(digits = 2) %>%
  adorn_ns()  # Show counts and percentages

# Print the sorted table
print(party_table)

party_table %>%
  gt() %>%
  tab_options(
    table.font.size = "medium",
    heading.title.font.size = "large"
  ) %>%
  cols_label(
    party = "Party",
    `0` = "Non-Allegiant",
    `1` = "Allegiant",
    `Total` = "Total"
  )
gtsave(party_table %>% gt(), "party_table.pdf")




# Define age ranges correctly
AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(agecat = case_when(
    ageEDay >= 18 & ageEDay <= 24 ~ "18-24",
    ageEDay >= 25 & ageEDay <= 29 ~ "25-29",
    ageEDay >= 30 & ageEDay <= 39 ~ "30-39",
    ageEDay >= 40 & ageEDay <= 49 ~ "40-49",
    ageEDay >= 50 & ageEDay <= 64 ~ "50-64",
    ageEDay >= 65 ~ "65+"
  ))

# Define voter type: Allegiant vs. Other
AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(voter_status = case_when(
    allegiant == 1 ~ "Allegiant Voter",
    allegiant == 0 ~ "Other Voter"
  ))

# Ensure factors are ordered correctly
AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(agecat = factor(agecat, levels = c("18-24", "25-29", "30-39", "40-49", "50-64", "65+")))

# Create age crosstab
age_table <- AllClarkCountyWide %>%
  tabyl(agecat, voter_status) %>%
  adorn_totals("row") %>%
  adorn_totals("col") %>%
  adorn_percentages("col") %>%
  adorn_pct_formatting(digits = 2) %>%
  adorn_ns()  # Show counts and percentages

# Print table
print(age_table)


age_table %>%
  gt() %>%
  cols_label(
    agecat = "Age Category",
    `Allegiant Voter` = "Allegiant",
    `Other Voter` = "Other Voter",
    `Total` = "Total"
  )
gtsave(party_table %>% gt(), "agejustallegiantandother.pdf")





# Compute average age by voter status
average_age <- AllClarkCountyWide %>%
  group_by(voter_status) %>%
  summarise(
    avg_age = mean(ageEDay, na.rm = TRUE),  # Calculate mean age
    sd_age = sd(ageEDay, na.rm = TRUE),     # Standard deviation
    min_age = min(ageEDay, na.rm = TRUE),   # Youngest voter
    max_age = max(ageEDay, na.rm = TRUE),   # Oldest voter
    count = n()                             # Number of voters in each group
  )

# Print the results
print(average_age)




```


                avg_age   sd_age min_age max_age count
Allegiant Voter	40.38101	13.5035 	18	   91	   4202
Other Voter   	47.39189	18.5357 	18   	122  	1635074



```{r provisional included}

# Create new column to classify voters
AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(allegiant_provisional = case_when(
    allegiant == 1 & votecode59 == "PV" ~ "Allegiant Provisional Voter",
    allegiant == 1 & votecode59 != "PV" ~ "Allegiant Regular Ballot Voter",
    allegiant == 0 & votecode59 == "PV" ~ "Other Provisional Voter",
    allegiant == 0 & votecode59 != "PV" ~ "Other Regular Ballot Voter"
  ))

# Check how many voters fall into each category
table(AllClarkCountyWide$allegiant_provisional)





# Define voter categories
AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(voter_category = case_when(
    allegiant == 1 ~ "Allegiant Voter",
    allegiant == 0 & votemethod2024 != 8 ~ "Other Voter",
    votemethod2024 == 8 ~ "Nonvoter"
  ))

# Check how many people fall into each category
table(AllClarkCountyWide$voter_category)



# Create crosstab for previous elections voted by voter type
vote_history_table <- AllClarkCountyWide %>%
  tabyl(numtimesvoted_beforeNov2024, voter_category) %>%
  adorn_totals("row") %>%  # Add total row
  adorn_totals("col") %>%  # Add total column
  adorn_percentages("col") %>%  # Convert to percentages
  adorn_pct_formatting(digits = 2) %>%  # Format percentages
  adorn_ns()  # Show both counts and percentages

# Print table
print(vote_history_table)
#accurate with slightly different for nonvoter and other voter








# Reclassify number of previous elections voted
AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(voter_category = case_when(
    allegiant == 1 ~ "Allegiant Voter",
    allegiant == 0 & votemethod2024 != 8 ~ "Other Voter",
    votemethod2024 == 8 ~ "Nonvoter"
  )) %>%
  mutate(vote_history_grouped = case_when(
    numtimesvoted_beforeNov2024 == 0 ~ "0",
    numtimesvoted_beforeNov2024 == 1 ~ "1",
    numtimesvoted_beforeNov2024 == 2 ~ "2",
    numtimesvoted_beforeNov2024 >= 3 ~ "3 to 16"
  ))

# Check distribution
table(AllClarkCountyWide$vote_history_grouped, AllClarkCountyWide$voter_category)




# Create crosstab with grouped voting history
vote_history_table <- AllClarkCountyWide %>%
  tabyl(vote_history_grouped, voter_category) %>%
  adorn_totals("row") %>%  # Add total row
  adorn_totals("col") %>%  # Add total column
  adorn_percentages("col") %>%  # Convert to percentages
  adorn_pct_formatting(digits = 2) %>%  # Format percentages
  adorn_ns()  # Show both counts and percentages

# Print the table
print(vote_history_table)

#looks good


colnames(AllClarkCountyWide)




# Categorize registration timing
AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(registration_category = case_when(
    reg_length < 0 ~ "Election Day",
    reg_length >= 0 & reg_length < 1 ~ "10/1 to 11/4/24",
    reg_length >= 1 ~ "2023 or earlier",
    TRUE ~ "Other"
  ))

# Check the distribution of registration categories
table(AllClarkCountyWide$registration_category)


# Ensure voter type classification is correct
AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(voter_category = case_when(
    allegiant == 1 ~ "Allegiant Voter",
    allegiant == 0 & votemethod2024 != 8 ~ "Other Voter",
    votemethod2024 == 8 ~ "Nonvoter"
  ))

# Check counts
table(AllClarkCountyWide$registration_category, AllClarkCountyWide$voter_category)



# Create crosstab for registration timing
registration_table <- AllClarkCountyWide %>%
  tabyl(registration_category, voter_category) %>%
  adorn_totals("row") %>%  # Add total row
  adorn_totals("col") %>%  # Add total column
  adorn_percentages("col") %>%  # Convert to percentages
  adorn_pct_formatting(digits = 2) %>%  # Format percentages
  adorn_ns()  # Show both counts and percentages

# Print table
print(registration_table)
#pretty different especially for election day
#think about why its different







# Categorize age into bins
AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(agecat = case_when(
    ageEDay >= 18 & ageEDay <= 24 ~ "18-24",
    ageEDay >= 25 & ageEDay <= 29 ~ "25-29",
    ageEDay >= 30 & ageEDay <= 39 ~ "30-39",
    ageEDay >= 40 & ageEDay <= 49 ~ "40-49",
    ageEDay >= 50 & ageEDay <= 64 ~ "50-65",
    ageEDay >= 65 ~ "65+"
  ))

# Ensure voter type classification is correct
AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(voter_category = case_when(
    allegiant == 1 ~ "Allegiant Voter",
    allegiant == 0 & votemethod2024 != 8 ~ "Other Voter",
    votemethod2024 == 8 ~ "Nonvoter"
  ))

# Check counts
table(AllClarkCountyWide$agecat, AllClarkCountyWide$voter_category)


# Create crosstab for age distribution
age_table <- AllClarkCountyWide %>%
  tabyl(agecat, voter_category) %>%
  adorn_totals("row") %>%  # Add total row
  adorn_totals("col") %>%  # Add total column
  adorn_percentages("col") %>%  # Convert to percentages
  adorn_pct_formatting(digits = 2) %>%  # Format percentages
  adorn_ns()  # Show both counts and percentages

# Print table
print(age_table)


average_age <- AllClarkCountyWide %>%
  group_by(voter_category) %>%
  summarise(
    avg_age = mean(ageEDay, na.rm = TRUE),
    sd_age = sd(ageEDay, na.rm = TRUE),
    min_age = min(ageEDay, na.rm = TRUE),
    max_age = max(ageEDay, na.rm = TRUE),
    count = n()
  )

# Print results
print(average_age)
#average age
#allegiant 40.3  nonvoter 42.04 other 50.58
#age looks good








# Categorize parties
AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(party_grouped = case_when(
    party == "Democrat" ~ "Democrat",
    party == "Republican" ~ "Republican",
    party == "Non-Partisan" ~ "Non-Partisan",
    TRUE ~ "Other"
  ))

# Define voter categories
AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(voter_category = case_when(
    allegiant == 1 ~ "Allegiant Voter",
    allegiant == 0 & votemethod2024 != 8 ~ "Other Voter",
    votemethod2024 == 8 ~ "Nonvoter"
  ))

# Check counts
table(AllClarkCountyWide$party_grouped, AllClarkCountyWide$voter_category)



# Create crosstab for party registration
party_table <- AllClarkCountyWide %>%
  tabyl(party_grouped, voter_category) %>%
  adorn_totals("row") %>%  # Add total row
  adorn_totals("col") %>%  # Add total column
  adorn_percentages("col") %>%  # Convert to percentages
  adorn_pct_formatting(digits = 2) %>%  # Format percentages
  adorn_ns()  # Show both counts and percentages

# Print table
print(party_table)
#looks good and the same

```


```{r checking report provisional voters}





table(AllClarkCountyWide$votecode59, AllClarkCountyWide$allegiant)


# Categorize voters based on location and ballot type
AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(voter_category = case_when(
    allegiant == 1 & votecode59 == "PV" ~ "Allegiant Provisional Voter",
    allegiant == 1 & votecode59 != "PV" ~ "Allegiant Regular Ballot Voter",
    allegiant == 0 & votecode59 == "PV" ~ "Other Vote Center Provisional Ballot Voter",  # FIXED
    allegiant == 0 & votecode59 != "PV" & votemethod2024 == 5 ~ "Other Vote Center Regular Ballot Voter"
  ))

# Check distribution again
table(AllClarkCountyWide$voter_category)



# Categorize previous elections voted
AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(vote_history_grouped = case_when(
    numtimesvoted_beforeNov2024 == 0 ~ "0",
    numtimesvoted_beforeNov2024 == 1 ~ "1",
    numtimesvoted_beforeNov2024 == 2 ~ "2",
    numtimesvoted_beforeNov2024 >= 3 ~ "3 to 16"
  ))

# Check distribution
table(AllClarkCountyWide$vote_history_grouped, AllClarkCountyWide$voter_category)



# Create crosstab
vote_history_table <- AllClarkCountyWide %>%
  tabyl(vote_history_grouped, voter_category) %>%
  adorn_totals("row") %>%  # Add total row
  adorn_totals("col") %>%  # Add total column
  adorn_percentages("col") %>%  # Convert to percentages
  adorn_pct_formatting(digits = 2) %>%  # Format percentages
  adorn_ns()  # Show both counts and percentages

# Print table
print(vote_history_table)

#looks the same






# Categorize registration timing
AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(registration_category = case_when(
    reg_length < 0 ~ "Election Day",
    reg_length >= 0 & reg_length < 1 ~ "10/1 to 11/4/24",
    reg_length >= 1 ~ "2023 or earlier",
    TRUE ~ "Other"
  ))

# Check distribution
table(AllClarkCountyWide$registration_category)

# Categorize voters
AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(voter_category = case_when(
    allegiant == 1 & votecode59 == "PV" ~ "Allegiant Provisional Voter",
    allegiant == 1 & votecode59 != "PV" ~ "Allegiant Regular Ballot Voter",
    allegiant == 0 & votecode59 == "PV" ~ "Other Vote Center Provisional Ballot Voter",
    allegiant == 0 & votecode59 != "PV" & votemethod2024 == 5 ~ "Other Vote Center Regular Ballot Voter"
  ))

# Check counts
table(AllClarkCountyWide$voter_category)


# Create crosstab for registration timing
registration_table <- AllClarkCountyWide %>%
  tabyl(registration_category, voter_category) %>%
  adorn_totals("row") %>%
  adorn_totals("col") %>%
  adorn_percentages("col") %>%
  adorn_pct_formatting(digits = 2) %>%
  adorn_ns()

# Print table
print(registration_table)
#this one is different too
#mostly election day for allegiant provisional voter








# Categorize age into bins
AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(agecat = case_when(
    ageEDay >= 18 & ageEDay <= 24 ~ "18-24",
    ageEDay >= 25 & ageEDay <= 29 ~ "25-29",
    ageEDay >= 30 & ageEDay <= 39 ~ "30-39",
    ageEDay >= 40 & ageEDay <= 49 ~ "40-49",
    ageEDay >= 50 & ageEDay <= 64 ~ "50-65",
    ageEDay >= 65 ~ "65+"
  ))

# Ensure voter category classification is correct
AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(voter_category = case_when(
    allegiant == 1 & votecode59 == "PV" ~ "Allegiant Provisional Voter",
    allegiant == 1 & votecode59 != "PV" ~ "Allegiant Regular Ballot Voter",
    allegiant == 0 & votecode59 == "PV" ~ "Other Vote Center Provisional Ballot Voter",
    allegiant == 0 & votecode59 != "PV" & votemethod2024 == 5 ~ "Other Vote Center Regular Ballot Voter"
  ))

# Check counts
table(AllClarkCountyWide$agecat, AllClarkCountyWide$voter_category)



# Create crosstab for age distribution
age_table <- AllClarkCountyWide %>%
  tabyl(agecat, voter_category) %>%
  adorn_totals("row") %>%
  adorn_totals("col") %>%
  adorn_percentages("col") %>%
  adorn_pct_formatting(digits = 2) %>%
  adorn_ns()

# Print table
print(age_table)

# Compute average age by voter status
average_age <- AllClarkCountyWide %>%
  group_by(voter_category) %>%
  summarise(
    avg_age = mean(ageEDay, na.rm = TRUE),
    sd_age = sd(ageEDay, na.rm = TRUE),
    min_age = min(ageEDay, na.rm = TRUE),
    max_age = max(ageEDay, na.rm = TRUE),
    count = n()
  )

# Print results
print(average_age)
#slightly different
#averages are different but table is the same








# Categorize parties
AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(party_grouped = case_when(
    party == "Democrat" ~ "Democrat",
    party == "Republican" ~ "Republican",
    party == "Non-Partisan" ~ "Non-Partisan",
    TRUE ~ "Other"
  ))

# Check the distribution
table(AllClarkCountyWide$party_grouped)

# Categorize voters
AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(voter_category = case_when(
    allegiant == 1 & votecode59 == "PV" ~ "Allegiant Provisional Voter",
    allegiant == 1 & votecode59 != "PV" ~ "Allegiant Regular Ballot Voter",
    allegiant == 0 & votecode59 == "PV" ~ "Other Vote Center Provisional Ballot Voter",
    allegiant == 0 & votecode59 != "PV" & votemethod2024 == 5 ~ "Other Vote Center Regular Ballot Voter"
  ))

# Check counts
table(AllClarkCountyWide$party_grouped, AllClarkCountyWide$voter_category)


# Create crosstab for party registration
party_table <- AllClarkCountyWide %>%
  tabyl(party_grouped, voter_category) %>%
  adorn_totals("row") %>%  # Add total row
  adorn_totals("col") %>%  # Add total column
  adorn_percentages("col") %>%  # Convert to percentages
  adorn_pct_formatting(digits = 2) %>%  # Format percentages
  adorn_ns()  # Show both counts and percentages

# Print table
print(party_table)
#its the same

```




```{r looking at registration again}

summary(AllClarkCountyWide$reg_length)

# Categorize registration timing
AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(registration_category = case_when(
    reg_length < 0 ~ "Election Day",
    reg_length >= 0 & reg_length < 1 ~ "10/1 to 11/4/24",
    reg_length >= 1 ~ "2023 or earlier",
    TRUE ~ "Other"
  ))

# Check the distribution of registration categories
table(AllClarkCountyWide$registration_category)





# Ensure voter type classification is correct
AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(voter_category = case_when(
    allegiant == 1 ~ "Allegiant Voter",
    allegiant == 0 & votemethod2024 != 8 ~ "Other Voter",
    votemethod2024 == 8 ~ "Nonvoter"
  ))

# Check counts
table(AllClarkCountyWide$registration_category, AllClarkCountyWide$voter_category)



# Create crosstab for registration timing
registration_table1 <- AllClarkCountyWide %>%
  tabyl(registration_category, voter_category) %>%
  adorn_totals("row") %>%  # Add total row
  adorn_totals("col") %>%  # Add total column
  adorn_percentages("col") %>%  # Convert to percentages
  adorn_pct_formatting(digits = 2) %>%  # Format percentages
  adorn_ns()  # Show both counts and percentages

# Print table
print(registration_table1)
#pretty different especially for election day
#think about why its different




AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(registration_category = case_when(
    reg_length < 0 ~ "Election Day",
    reg_length >= 0 & reg_length < 1 ~ "10/1 to 11/4/24",
    reg_length >= 1 ~ "2023 or earlier",
    TRUE ~ "Other"
  ))

# Check distribution
table(AllClarkCountyWide$registration_category)

# Categorize voters
AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(voter_category = case_when(
    allegiant == 1 & votecode59 == "PV" ~ "Allegiant Provisional Voter",
    allegiant == 1 & votecode59 != "PV" ~ "Allegiant Regular Ballot Voter",
    allegiant == 0 & votecode59 == "PV" ~ "Other Vote Center Provisional Ballot Voter",
    allegiant == 0 & votecode59 != "PV" & votemethod2024 == 5 ~ "Other Vote Center Regular Ballot Voter"
  ))

# Check counts
table(AllClarkCountyWide$voter_category)


# Create crosstab for registration timing
registration_table2 <- AllClarkCountyWide %>%
  tabyl(registration_category, voter_category) %>%
  adorn_totals("row") %>%
  adorn_totals("col") %>%
  adorn_percentages("col") %>%
  adorn_pct_formatting(digits = 2) %>%
  adorn_ns()

# Print table
print(registration_table2)
#this one is different too
#mostly election day for allegiant provisional voter


#attempts to fix



# Use existing reg_length variable to categorize registration dates
AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(registration_category = case_when(
    reg_length == 0 ~ "Election Day",  # Registered on Election Day (Nov 5, 2024)
    reg_length > 0 & reg_length <= 0.096 ~ "10/1 to 11/4/24",  # Registered between October 1 and November 4, 2024
    reg_length > 1 ~ "2023 or earlier",  # Registered in 2023 or earlier
    TRUE ~ "Other"  # Catch-all for anything else
  ))

# Check the distribution of categories
table(AllClarkCountyWide$registration_category)



# Create crosstab for registration timing
registration_table3 <- AllClarkCountyWide %>%
  tabyl(registration_category, voter_category) %>%
  adorn_totals("row") %>%
  adorn_totals("col") %>%
  adorn_percentages("col") %>%
  adorn_pct_formatting(digits = 2) %>%
  adorn_ns()

# Print table
print(registration_table3)



registration_table4 <- AllClarkCountyWide %>%
  tabyl(registration_category, voter_category) %>%
  adorn_totals("row") %>%
  adorn_totals("col") %>%
  adorn_percentages("col") %>%
  adorn_pct_formatting(digits = 2) %>%
  adorn_ns()

# Print table
print(registration_table4)





#age
average_age <- AllClarkCountyWide %>%
  group_by(voter_category) %>%
  summarise(
    avg_age = mean(ageEDay, na.rm = TRUE),
    sd_age = sd(ageEDay, na.rm = TRUE),
    min_age = min(ageEDay, na.rm = TRUE),
    max_age = max(ageEDay, na.rm = TRUE),
    count = n()
  )

# Print results
print(average_age)
#slightly different
#averages are different but table is the same
```




```{r voting method analysis}





# Categorize voting methods
AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(voting_method = case_when(
    votecode59 == "PV" ~ "Provisional",
    votecode59 == "PP" ~ "Polling Place",
    votecode59 == "MB" ~ "Mail Ballot",
    votecode59 == "EV" ~ "Early Voting",
    votecode59 == "" ~ "Did Not Vote",
    TRUE ~ "Other"
  ))

# Categorize voters as Allegiant vs. Non-Allegiant
AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(allegiant_status = case_when(
    allegiant == 1 ~ "Allegiant Voter",
    allegiant == 0 ~ "Non-Allegiant Voter"
  ))

# Check distribution
table(AllClarkCountyWide$voting_method, AllClarkCountyWide$allegiant_status)



# Create crosstab for voting method by Allegiant vs. Non-Allegiant Voters
voting_method_table <- AllClarkCountyWide %>%
  tabyl(voting_method, allegiant_status) %>%
  adorn_totals("row") %>%
  adorn_totals("col") %>%
  adorn_percentages("col") %>%
  adorn_pct_formatting(digits = 2) %>%
  adorn_ns()

# Print table
print(voting_method_table)









# Define the voting method columns (adjust if they have different names)
voting_columns <- paste0("votecode", 41:59)  # Elections from votecode41 to votecode59

# Create new columns to count occurrences of each voting method
AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(
    count_provisional = rowSums(select(., all_of(voting_columns)) == "PV", na.rm = TRUE),
    count_polling_place = rowSums(select(., all_of(voting_columns)) == "PP", na.rm = TRUE),
    count_mail = rowSums(select(., all_of(voting_columns)) == "MB", na.rm = TRUE),
    count_early_voting = rowSums(select(., all_of(voting_columns)) == "EV", na.rm = TRUE)
  )


# Assign the most frequently used voting method
AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(primary_voting_method = case_when(
    count_provisional == pmax(count_provisional, count_polling_place, count_mail, count_early_voting) ~ "Provisional",
    count_polling_place == pmax(count_provisional, count_polling_place, count_mail, count_early_voting) ~ "Polling Place",
    count_mail == pmax(count_provisional, count_polling_place, count_mail, count_early_voting) ~ "Mail Ballot",
    count_early_voting == pmax(count_provisional, count_polling_place, count_mail, count_early_voting) ~ "Early Voting",
    TRUE ~ "Other"
  ))

# Check the results
table(AllClarkCountyWide$primary_voting_method)


voting_method_table <- AllClarkCountyWide %>%
  tabyl(primary_voting_method, allegiant_status) %>%
  adorn_totals("row") %>%
  adorn_totals("col") %>%
  adorn_percentages("col") %>%
  adorn_pct_formatting(digits = 2) %>%
  adorn_ns()
print(voting_method_table)




table(ReturningAllegiantVoters$votecode59, useNA = "always")



# Count Nov 2024 Voting Methods
nov_2024_counts <- table(ReturningAllegiantVoters$nov2024_voting_method)

# Count Primary (Most Frequent) Voting Methods
primary_counts <- table(ReturningAllegiantVoters$primary_voting_method)

# Convert tables to data frames
nov_2024_df <- as.data.frame(nov_2024_counts)
primary_df <- as.data.frame(primary_counts)

# Rename columns for clarity
colnames(nov_2024_df) <- c("Voting Method", "Nov 2024 Allegiant Voters")
colnames(primary_df) <- c("Voting Method", "Primary Voting Method")

# Merge both tables by Voting Method
voting_comparison_table <- full_join(nov_2024_df, primary_df, by = "Voting Method") %>%
  replace(is.na(.), 0)  # Replace NA with 0 if there are missing categories

# Add percentages
voting_comparison_table <- voting_comparison_table %>%
  mutate(
    `Nov 2024 Percentage` = round(100 * `Nov 2024 Allegiant Voters` / sum(`Nov 2024 Allegiant Voters`), 2),
    `Primary Percentage` = round(100 * `Primary Voting Method` / sum(`Primary Voting Method`), 2)
  )

# Print the final table
print(voting_comparison_table)




```
voting_method Allegiant Voter Non-Allegiant Voter               Total
  Early Voting   0.00%     (0)  23.71%   (387,651)  23.65%   (387,651)
   Mail Ballot   0.00%     (0)  26.98%   (441,082)  26.91%   (441,082)
         Other   0.00%     (0)  37.36%   (610,788)  37.26%   (610,788)
 Polling Place  93.48% (3,928)  10.87%   (177,678)  11.08%   (181,606)
   Provisional   6.52%   (274)   1.09%    (17,875)   1.11%    (18,149)
         Total 100.00% (4,202) 100.00% (1,635,074) 100.00% (1,639,276)
         
         
         across time
   primary_voting_method Allegiant Voter Non-Allegiant Voter               Total
          Early Voting   8.81%   (370)  24.63%   (402,772)  24.59%   (403,142)
           Mail Ballot   3.09%   (130)  27.66%   (452,278)  27.60%   (452,408)
         Polling Place  77.15% (3,242)  20.56%   (336,095)  20.70%   (339,337)
           Provisional  10.95%   (460)  27.15%   (443,929)  27.11%   (444,389)
                 Total 100.00% (4,202) 100.00% (1,635,074) 100.00% (1,639,276)
         
         
  just allegiant returning voters
  Voting Method	 Nov 2024 Allegiant Voters	 Nov 2024 Percentage	Primary Voting Method	 Primary Percentage
Polling Place         	 2,712	    99.8%	                         2,026	74.6%
Provisional	            5	       0.2%	                             191	7.0%
Mail Ballot	             0	      0.0%                            	130	4.8%
Early Voting   	         0	     0.0%	                            370	13.6%
Total	                 2,717	   100%	                            2,717	100%




```{r first time allegiant voters analysis}


# Categorize Allegiant voters as first-time or returning
AllegiantVoters <- AllClarkCountyWide %>%
  filter(allegiant == 1) %>%
  mutate(voter_type = case_when(
    numtimesvoted_beforeNov2024 == 0 ~ "First-Time Allegiant Voter",
    numtimesvoted_beforeNov2024 > 0 ~ "Returning Allegiant Voter"
  ))

# Create crosstab for party registration
firstparty_table <- AllegiantVoters %>%
  tabyl(voter_type, party_grouped) %>%
  adorn_totals("row") %>%
  adorn_totals("col") %>%
  adorn_percentages("row") %>%
  adorn_pct_formatting(digits = 2) %>%
  adorn_ns()

# Print the table
print(firstparty_table)



# Categorize Non-Allegiant voters as first-time or returning
NonAllegiantVoters <- AllClarkCountyWide %>%
  filter(allegiant == 0) %>%
  mutate(voter_type = case_when(
    numtimesvoted_beforeNov2024 == 0 ~ "First-Time Non-Allegiant Voter",
    numtimesvoted_beforeNov2024 > 0 ~ "Returning Non-Allegiant Voter"
  ))

# Create crosstab for party registration
party_table_non_allegiant <- NonAllegiantVoters %>%
  tabyl(voter_type, party_grouped) %>%
  adorn_totals("row") %>%
  adorn_totals("col") %>%
  adorn_percentages("row") %>%
  adorn_pct_formatting(digits = 2) %>%
  adorn_ns()

# Print the table
print(party_table_non_allegiant)



# Create crosstab for age categories
firstage_table <- AllegiantVoters %>%
  tabyl(voter_type, agecat) %>%
  adorn_totals("row") %>%
  adorn_totals("col") %>%
  adorn_percentages("row") %>%
  adorn_pct_formatting(digits = 2) %>%
  adorn_ns()

# Print the table
print(firstage_table)



# Create crosstab for age categories
age_table_non_allegiant <- NonAllegiantVoters %>%
  tabyl(voter_type, agecat) %>%
  adorn_totals("row") %>%
  adorn_totals("col") %>%
  adorn_percentages("row") %>%
  adorn_pct_formatting(digits = 2) %>%
  adorn_ns()

# Print the table
print(age_table_non_allegiant)





# Filter for first-time voters (numtimesvoted_beforeNov2024 == 0)
FirstTimeVoters <- AllClarkCountyWide %>%
  filter(numtimesvoted_beforeNov2024 == 0)

# Calculate average age by voter type (Allegiant vs. Non-Allegiant)
average_age_first_time <- FirstTimeVoters %>%
  group_by(allegiant) %>%
  summarise(Average_Age = mean(ageEDay, na.rm = TRUE))

# Print results
print(average_age_first_time)

#allegiant first time voter 36.03
#nonallegiant first time voter 39


```

print(firstparty_table)
                 voter_type       Democrat   Non-Partisan       Other     Republican           Total
 First-Time Allegiant Voter 19.87%   (295) 50.57%   (751) 5.99%  (89) 23.57%   (350) 100.00% (1,485)
  Returning Allegiant Voter 39.68% (1,078) 28.38%   (771) 7.18% (195) 24.77%   (673) 100.00% (2,717)
                      Total 32.67% (1,373) 36.22% (1,522) 6.76% (284) 24.35% (1,023) 100.00% (4,202)
                      
print(party_table_non_allegiant)
                     voter_type         Democrat     Non-Partisan       Other       Republican               Total
 First-Time Non-Allegiant Voter 18.88% (112,784) 60.05% (358,645) 6.58%  (39,280) 14.49%  (86,566) 100.00%   (597,275)
  Returning Non-Allegiant Voter 38.75% (402,168) 22.56% (234,176) 7.28%  (75,553) 31.40% (325,902) 100.00% (1,037,799)
                          Total 31.49% (514,952) 36.26% (592,821) 7.02% (114,833) 25.23% (412,468) 100.00% (1,635,074)
                      
                      
 
     voter_type                 18-24        25-29          30-39        40-49        50-65         65+           Total
 First-Time Allegiant Voter 20.67% (307) 14.14% (210) 29.90%   (444) 20.13% (299) 13.00% (193) 2.15%  (32) 100.00% (1,485)
  Returning Allegiant Voter  6.81% (185) 12.22% (332) 26.13%   (710) 24.73% (672) 23.00% (625) 7.10% (193) 100.00% (2,717)
                      Total 11.71% (492) 12.90% (542) 27.46% (1,154) 23.11% (971) 19.47% (818) 5.35% (225) 100.00% (4,202)
                      
 
   voter_type                      18-24            25-29            30-39            40-49            50-65              65+
 First-Time Non-Allegiant Voter 22.75% (135,878) 12.91%  (77,079) 23.69% (141,483) 15.12%  (90,316) 15.83%  (94,549)  9.71%  (57,970)
  Returning Non-Allegiant Voter  5.18%  (53,760)  7.05%  (73,199) 16.40% (170,201) 16.64% (172,699) 26.53% (275,294) 28.20% (292,646)
                          Total 11.60% (189,638)  9.19% (150,278) 19.06% (311,684) 16.09% (263,015) 22.62% (369,843) 21.44% (350,616)
               Total
 100.00%   (597,275)
 100.00% (1,037,799)
 100.00% (1,635,074)                    
 
 
 
```{r}




# Filter for voters who registered on Election Day
ElectionDayVoters <- AllClarkCountyWide %>%
  filter(registration_category == "Election Day") %>%
  mutate(voter_type = case_when(
    allegiant == 1 ~ "Allegiant Voter",
    allegiant == 0 ~ "Non-Allegiant Voter"
  ))



# Create crosstab for party affiliation
party_table_ED <- ElectionDayVoters %>%
  tabyl(voter_type, party_grouped) %>%
  adorn_totals("row") %>%
  adorn_totals("col") %>%
  adorn_percentages("row") %>%
  adorn_pct_formatting(digits = 2) %>%
  adorn_ns()

# Print table
print(party_table_ED)


# Create crosstab for age categories
age_table_ED <- ElectionDayVoters %>%
  tabyl(voter_type, agecat) %>%
  adorn_totals("row") %>%
  adorn_totals("col") %>%
  adorn_percentages("row") %>%
  adorn_pct_formatting(digits = 2) %>%
  adorn_ns()

# Print table
print(age_table_ED)



# Filter for Election Day registrants
ElectionDayVoters <- AllClarkCountyWide %>%
  filter(registration_category == "Election Day")

# Calculate average age by voter type (Allegiant vs. Non-Allegiant)
average_age_ED <- ElectionDayVoters %>%
  group_by(allegiant) %>%
  summarise(Average_Age = mean(ageEDay, na.rm = TRUE))

# Print results
print(average_age_ED)
#allegiant election day registration average age 37.67
#nonallegiant election day registration average age 35.98

```
Just election day registration
print(party_table_ED)
          voter_type       Democrat   Non-Partisan       Other     Republican           Total
     Allegiant Voter 31.91%    (60) 26.06%    (49) 6.38%  (12) 35.64%    (67) 100.00%   (188)
 Non-Allegiant Voter 30.75% (2,550) 29.51% (2,447) 7.84% (650) 31.91% (2,646) 100.00% (8,293)
               Total 30.77% (2,610) 29.43% (2,496) 7.81% (662) 31.99% (2,713) 100.00% (8,481)
               
               
 print(age_table_ED)
          voter_type          18-24          25-29          30-39          40-49          50-65         65+           Total
     Allegiant Voter 16.49%    (31) 13.30%    (25) 31.91%    (60) 19.15%    (36) 17.02%    (32) 2.13%   (4) 100.00%   (188)
 Non-Allegiant Voter 29.56% (2,451) 13.06% (1,083) 23.21% (1,925) 13.72% (1,138) 13.73% (1,139) 6.72% (557) 100.00% (8,293)
               Total 29.27% (2,482) 13.06% (1,108) 23.41% (1,985) 13.84% (1,174) 13.81% (1,171) 6.61% (561) 100.00% (8,481)
               
               
               
               
```{r graphs}


# Categorize voters into four groups
AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(voter_category = case_when(
    allegiant == 1 & numtimesvoted_beforeNov2024 == 0 ~ "Allegiant First-Time",
    allegiant == 1 & numtimesvoted_beforeNov2024 > 0 ~ "Allegiant Returning",
    allegiant == 0 & numtimesvoted_beforeNov2024 == 0 ~ "Non-Allegiant First-Time",
    allegiant == 0 & numtimesvoted_beforeNov2024 > 0 ~ "Non-Allegiant Returning"
  ))

# Calculate total Allegiant and Non-Allegiant voters
total_allegiant <- sum(AllClarkCountyWide$allegiant == 1)
total_non_allegiant <- sum(AllClarkCountyWide$allegiant == 0)

# Compute age category distribution for each voter category
age_distribution <- AllClarkCountyWide %>%
  group_by(agecat, voter_category) %>%
  summarise(count = n(), .groups = "drop") %>%
  mutate(
    total_group = case_when(
      voter_category %in% c("Allegiant First-Time", "Allegiant Returning") ~ total_allegiant,
      voter_category %in% c("Non-Allegiant First-Time", "Non-Allegiant Returning") ~ total_non_allegiant
    ),
    percentage = (count / total_group) * 100
  )

# Create the line plot
ggplot(age_distribution, aes(x = as.factor(agecat), y = percentage, color = voter_category, group = voter_category)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  labs(title = "Age Category Distribution by Voter Category (Percentage of Allegiant/Non-Allegiant)",
       x = "Age Category",
       y = "Percentage of Group",
       color = "Voter Category") +
  theme_minimal()







colnames(AllClarkCountyWide)
table(AllClarkCountyWide$votemethod2024, useNA = "always")
table(AllClarkCountyWide$votecode59, useNA = "always")

AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(voter_category = case_when(
    allegiant == 1 & !is.na(votecode59) ~ "Allegiant 2024 Voter",
    allegiant == 0 & !is.na(votecode59) ~ "Non-Allegiant 2024 Voter",
    is.na(votecode59) ~ "Non-2024 Voter"
  ))


AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(numtimesvoted_grouped = case_when(
    numtimesvoted_beforeNov2024 < 5 ~ as.character(numtimesvoted_beforeNov2024),
    numtimesvoted_beforeNov2024 >= 5 ~ "5+"
  ))


total_counts <- AllClarkCountyWide %>%
  group_by(voter_category) %>%
  summarise(total_group = n(), .groups = "drop")

prior_votes_distribution <- AllClarkCountyWide %>%
  group_by(numtimesvoted_grouped, voter_category) %>%
  summarise(count = n(), .groups = "drop") %>%
  left_join(total_counts, by = "voter_category") %>%
  mutate(percentage = (count / total_group) * 100)


AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(voter_category = factor(voter_category, levels = c("Non-2024 Voter", "Allegiant 2024 Voter", "Non-Allegiant 2024 Voter")))



ggplot(prior_votes_distribution, aes(x = numtimesvoted_grouped, y = percentage, fill = voter_category)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Voting History Distribution: Allegiant 2024 Voters, Non-Allegiant 2024 Voters, \nand Non-2024 Voters",
       x = "Number of Times Voted Before Nov 2024",
       y = "Percentage of Group",
       fill = "Voter Category") +
  scale_fill_manual(values = c("Non-2024 Voter" = "#377eb8",  # Blue
                               "Allegiant 2024 Voter" = "#4daf4a",  # Green
                               "Non-Allegiant 2024 Voter" = "#e41a1c")) +  # Red
  theme_minimal()








# Categorize voters into three groups based on their voting status in Nov 2024
AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(voter_category = case_when(
    allegiant == 1 & !is.na(votecode59) ~ "Allegiant 2024 Voter",
    allegiant == 0 & !is.na(votecode59) ~ "Non-Allegiant 2024 Voter",
    is.na(votecode59) ~ "Non-2024 Voter"
  ))

# Calculate total voters in each category
total_counts <- AllClarkCountyWide %>%
  group_by(voter_category) %>%
  summarise(total_group = n(), .groups = "drop")

# Compute party distribution for each voter category using party_grouped
party_distribution <- AllClarkCountyWide %>%
  group_by(party_grouped, voter_category) %>%
  summarise(count = n(), .groups = "drop") %>%
  left_join(total_counts, by = "voter_category") %>%
  mutate(percentage = (count / total_group) * 100)

# Ensure correct order of voter categories (Non-2024 Voter first)
party_distribution <- party_distribution %>%
  mutate(voter_category = factor(voter_category, levels = c("Non-2024 Voter", "Allegiant 2024 Voter", "Non-Allegiant 2024 Voter")))

# Create the bar plot
ggplot(party_distribution, aes(x = party_grouped, y = percentage, fill = voter_category)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Party Affiliation Distribution: Allegiant 2024 Voters, \n Non-Allegiant 2024 Voters, and Non-2024 Voters",
       x = "Party",
       y = "Percentage of Category",
       fill = "Voter Category") +
  scale_fill_manual(values = c("Non-2024 Voter" = "#377eb8",  # Blue
                               "Allegiant 2024 Voter" = "#4daf4a",  # Green
                               "Non-Allegiant 2024 Voter" = "#e41a1c")) +  # Red
  theme_minimal()




party_distribution <- AllClarkCountyWide %>%
  group_by(voter_category, party_grouped) %>%
  summarise(count = n(), .groups = "drop") %>%
  left_join(total_counts, by = "voter_category") %>%
  mutate(percentage = (count / total_group) * 100)

# Create the flipped bar plot
ggplot(party_distribution, aes(x = voter_category, y = percentage, fill = party_grouped)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Party Affiliation by Voter Category: Non-2024, Allegiant, and Non-Allegiant Voters",
       x = "Voter Category",
       y = "Percentage of Group",
       fill = "Party") +
  scale_fill_manual(values = c("Democrat" = "#377eb8",  # Blue
                               "Republican" = "#e41a1c",  # Red
                               "Non-Partisan" = "#4daf4a",  # Green
                               "Other" = "#984ea3")) +  # Purple
  theme_minimal()


```
```{r more graphs}





# Convert registration date to Date format if not already
AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(regdate = as.Date(regdate, format="%Y-%m-%d"))

# Categorize voters into three groups based on their voting status in Nov 2024
AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(voter_category = case_when(
    allegiant == 1 & !is.na(votecode59) ~ "Allegiant 2024 Voter",
    allegiant == 0 & !is.na(votecode59) ~ "Non-Allegiant 2024 Voter",
    is.na(votecode59) ~ "Non-2024 Voter"
  ))



registrations_over_time <- AllClarkCountyWide %>%
  filter(regdate >= as.Date("2016-01-01")) %>%
  group_by(reg_month = format(regdate, "%Y-%m"), voter_category) %>%
  summarise(count = n(), .groups = "drop")

# Convert month to Date type for proper plotting
registrations_over_time <- registrations_over_time %>%
  mutate(reg_month = as.Date(paste0(reg_month, "-01")))


# Calculate total registrations within each voter group
total_registrations_by_group <- AllClarkCountyWide %>%
  group_by(voter_category) %>%
  summarise(total_group = n(), .groups = "drop")

# Merge to get percentage within each voter group
registrations_over_time <- registrations_over_time %>%
  left_join(total_registrations_by_group, by = "voter_category") %>%
  mutate(percentage = (count / total_group) * 100)

# Calculate the total percentage of all registered voters (voters + non-voters)
total_registrations_over_time <- AllClarkCountyWide %>%
  filter(regdate >= as.Date("2016-01-01")) %>%
  group_by(reg_month = format(regdate, "%Y-%m")) %>%
  summarise(count = n(), .groups = "drop") %>%
  mutate(reg_month = as.Date(paste0(reg_month, "-01")),
         total_group = nrow(AllClarkCountyWide), # Total number of all registered voters
         percentage = (count / total_group) * 100,
         voter_category = "All Registered Voters")

# Combine both datasets
registrations_over_time <- bind_rows(registrations_over_time, total_registrations_over_time)

# Create the line plot with all four categories
ggplot(registrations_over_time, aes(x = reg_month, y = percentage, color = voter_category)) +
  geom_line(size = 1) +
  geom_point() +
  labs(title = "Percentage of Total Registrations Over Time by Voter Category (2016 Onward)",
       x = "Registration Date",
       y = "Percentage of Group Registrations",
       color = "Voter Category") +
  theme_minimal()


ggplot(registrations_over_time, aes(x = reg_month, y = percentage, color = voter_category)) +
  geom_line(size = 1) +
  geom_point() +
  labs(title = "Percentage of Total Registrations Over Time by Voter Category (2016 Onward)",
       x = "Registration Date",
       y = "Percentage of Group Registrations",
       color = "Voter Category") +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +  # Add more x-axis labels for detail
  theme_minimal() +
  theme(
    plot.margin = margin(1, 2, 1, 2, "cm"),  # Add extra space around the graph
    axis.text.x = element_text(angle = 45, hjust = 1),  # Rotate x-axis labels for readability
    aspect.ratio = 2/3  # Stretch the plot horizontally
  )
```
```{r method}

colnames(AllClarkCountyWide)


library(dplyr)

# Define the voting columns (excluding Nov 2024)
before2024voting_columns <- paste0("votecode", 41:58)  # Adjust this based on your dataset

# Count how many times each method was used before Nov 2024
AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(
    count_provisional = rowSums(select(., all_of(before2024voting_columns)) == "PV", na.rm = TRUE),
    count_polling_place = rowSums(select(., all_of(before2024voting_columns)) == "PP", na.rm = TRUE),
    count_mail = rowSums(select(., all_of(before2024voting_columns)) == "MB", na.rm = TRUE),
    count_early_voting = rowSums(select(., all_of(before2024voting_columns)) == "EV", na.rm = TRUE)
  )

# Assign the most frequently used voting method before Nov 2024
AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(primary_voting_method_prior = case_when(
    count_provisional == pmax(count_provisional, count_polling_place, count_mail, count_early_voting) ~ "Provisional",
    count_polling_place == pmax(count_provisional, count_polling_place, count_mail, count_early_voting) ~ "Polling Place",
    count_mail == pmax(count_provisional, count_polling_place, count_mail, count_early_voting) ~ "Mail Ballot",
    count_early_voting == pmax(count_provisional, count_polling_place, count_mail, count_early_voting) ~ "Early Voting",
    TRUE ~ "Other"
  ))

# View a sample of the new column
head(AllClarkCountyWide %>% select(voterid, primary_voting_method_prior))


primary_voting_crosstab <- AllClarkCountyWide %>%
  tabyl(primary_voting_method_prior, allegiant) %>%
  adorn_totals("row") %>%  # Add row total
  adorn_totals("col") %>%  # Add column total
  adorn_percentages("col") %>%  # Convert to column-wise percentages
  adorn_pct_formatting(digits = 2) %>%  # Format as percentages
  adorn_ns()  # Add raw count in parentheses

# Print the formatted table
print(primary_voting_crosstab)





AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(voter_category = case_when(
    allegiant == 1 & !is.na(votecode59) ~ "Allegiant 2024 Voter",
    allegiant == 0 & !is.na(votecode59) ~ "Non-Allegiant 2024 Voter",
    is.na(votecode59) ~ "Non-2024 Voter"
  ))


primary_voting_crosstab <- AllClarkCountyWide %>%
  tabyl(primary_voting_method_prior, voter_category) %>%
  adorn_totals("row") %>%
  adorn_totals("col") %>%
  adorn_percentages("col") %>%  # Convert to column-wise percentages
  adorn_pct_formatting(digits = 2) %>%  # Format as percentages
  adorn_ns()  # Add raw count in parentheses

# Print the formatted table
print(primary_voting_crosstab)






install.packages("ggalluvial")
library(ggalluvial)

AllClarkCountyWide %>%
  filter(!is.na(primary_voting_method_prior) & !is.na(votemethod2024)) %>%
  ggplot(aes(axis1 = primary_voting_method_prior, axis2 = votemethod2024, fill = voter_category)) +
  geom_alluvium(aes(y = 1), width = 0.1) +
  geom_stratum() +
  geom_text(stat = "stratum", aes(label = after_stat(stratum))) +
  labs(title = "Voting Method Transitions: Before vs. Nov 2024",
       x = "Voting Method", y = "Number of Voters",
       fill = "Voter Category") +
  theme_minimal()




AllClarkCountyWide %>%
  mutate(total_methods_used = count_provisional + count_polling_place + count_mail + count_early_voting) %>%
  ggplot(aes(x = total_methods_used, y = voter_category, fill = ..count..)) +
  geom_tile() +
  labs(title = "Variation in Voting Methods Used: Allegiant vs. Non-Allegiant vs. Non-2024",
       x = "Number of Different Voting Methods Used",
       y = "Voter Type",
       fill = "Number of Voters") +
  theme_minimal()



library(ggridges)

AllClarkCountyWide %>%
  pivot_longer(cols = c(count_provisional, count_polling_place, count_mail, count_early_voting),
               names_to = "VotingMethod", values_to = "Count") %>%
  ggplot(aes(x = Count, y = VotingMethod, fill = voter_category)) +
  geom_density_ridges(alpha = 0.7) +
  labs(title = "Voting Method Distribution Across Elections",
       x = "Times Used",
       y = "Voting Method",
       fill = "Voter Category") +
  theme_minimal()



```


all voters vs allegiant
 primary_voting_method_prior                   0               1               Total
                Early Voting  21.41%   (349,989)  16.44%   (691)  21.39%   (350,680)
                 Mail Ballot  21.08%   (344,744)  10.90%   (458)  21.06%   (345,202)
               Polling Place  18.46%   (301,892)  31.56% (1,326)  18.50%   (303,218)
                 Provisional  39.05%   (638,449)  41.10% (1,727)  39.05%   (640,176)
                       Total 100.00% (1,635,074) 100.00% (4,202) 100.00% (1,639,276)
                       
                       
primary_voting_method_prior Allegiant 2024 Voter    Non-2024 Voter Non-Allegiant 2024 Voter               Total
                Early Voting       16.44%   (691)   9.71%  (59,284)       28.38%   (290,705)  21.39%   (350,680)
                 Mail Ballot       10.90%   (458)  11.40%  (69,600)       26.86%   (275,144)  21.06%   (345,202)
               Polling Place       31.56% (1,326)  12.28%  (75,011)       22.15%   (226,881)  18.50%   (303,218)
                 Provisional       41.10% (1,727)  66.62% (406,893)       22.61%   (231,556)  39.05%   (640,176)
                       Total      100.00% (4,202) 100.00% (610,788)      100.00% (1,024,286) 100.00% (1,639,276)
                       
                       
                       
                       
```{r voting method previous}



# Ensure proper mapping of votecode59 values
AllegiantVoters <- AllClarkCountyWide %>%
  filter(allegiant == 1) %>%
  mutate(voting_method_2024 = case_when(
    votecode59 == "PP" ~ "Polling Place",
    votecode59 == "PV" ~ "Provisional",
    votecode59 == "MB" ~ "Mail Ballot",
    votecode59 == "EV" ~ "Early Voting",
    TRUE ~ "Unknown"
  ))

# Identify voting method columns excluding 2024
voting_method_columns_prior <- names(AllClarkCountyWide)[grepl("votecode[0-9]+", names(AllClarkCountyWide)) & names(AllClarkCountyWide) != "votecode59"]

# Extract last voting method before 2024
AllegiantVoters <- AllegiantVoters %>%
  rowwise() %>%
  mutate(last_voting_method_prior = {
    voting_methods <- c_across(all_of(voting_method_columns_prior))
    last_method <- tail(na.omit(voting_methods), 1)
    ifelse(length(last_method) > 0, last_method, "No Previous Vote")
  }) %>%
  ungroup()

# Ensure last voting method is labeled correctly
AllegiantVoters <- AllegiantVoters %>%
  mutate(last_voting_method_prior = case_when(
    last_voting_method_prior == "PP" ~ "Polling Place",
    last_voting_method_prior == "PV" ~ "Provisional",
    last_voting_method_prior == "MB" ~ "Mail Ballot",
    last_voting_method_prior == "EV" ~ "Early Voting",
    last_voting_method_prior == "No Previous Vote" ~ "No Previous Vote",
    TRUE ~ "Other"
  ))

# Create a crosstab with 2024 method as columns and last used method as rows
allegiant_voting_crosstab <- AllegiantVoters %>%
  tabyl(voting_method_2024, last_voting_method_prior) %>%
  adorn_totals("row") %>%
  adorn_totals("col") %>%
  adorn_percentages("col") %>%
  adorn_pct_formatting(digits = 2) %>%
  adorn_ns()

# Print the formatted table
print(allegiant_voting_crosstab)



library(dplyr)
library(janitor)

# Identify voting method columns excluding 2024
voting_method_columns_prior <- names(AllClarkCountyWide)[grepl("votecode[0-9]+", names(AllClarkCountyWide)) & names(AllClarkCountyWide) != "votecode59"]

# Identify Allegiant voters and get last voting method before 2024
AllegiantVoters <- AllClarkCountyWide %>%
  filter(allegiant == 1) %>%
  rowwise() %>%
  mutate(last_voting_method_prior = {
    voting_methods <- c_across(all_of(voting_method_columns_prior))
    last_method <- tail(na.omit(voting_methods), 1)
    ifelse(length(last_method) > 0, last_method, "No Previous Vote")
  }) %>%
  ungroup()

# Count how many used each method in 2024
voting_summary <- AllegiantVoters %>%
  count(votecode59, name = "Count_2024") %>%
  rename(`Voting Method` = votecode59)

# Count how many used each method in their last recorded vote
last_vote_summary <- AllegiantVoters %>%
  count(last_voting_method_prior, name = "Count_Last") %>%
  rename(`Voting Method` = last_voting_method_prior)

# Merge both summaries
final_voting_table <- full_join(voting_summary, last_vote_summary, by = "Voting Method") %>%
  replace_na(list(Count_2024 = 0, Count_Last = 0))  # Fill NA with 0

# Compute percentages
total_voters <- nrow(AllegiantVoters)
final_voting_table <- final_voting_table %>%
  mutate(
    `Percentage of Allegiant Voters (2024)` = round((Count_2024 / total_voters) * 100, 2),
    `Percentage of Allegiant Voters (Last Vote)` = round((Count_Last / total_voters) * 100, 2)
  )

# Print the formatted table
print(final_voting_table)

library(knitr)

# Print the table in an easy-to-copy format
final_voting_table %>%
  kable(format = "pipe", digits = 2, align = "c", col.names = c("Voting Method", "Count 2024", "% Allegiant Voters (2024)", "Count Last Vote", "% Allegiant Voters (Last Vote)"))



library(gt)

# Print the table in an easy-to-copy format using `gt`
final_voting_table %>%
  gt() %>%
  tab_header(title = "Allegiant Voters: 2024 vs. Last Voting Method") %>%
  fmt_number(columns = c("Count_2024", "Count_Last"), decimals = 0) %>%
  fmt_percent(columns = c("Percentage of Allegiant Voters (2024)", "Percentage of Allegiant Voters (Last Vote)"), decimals = 2)


print(final_voting_table, row.names = FALSE)



library(dplyr)
library(janitor)
library(knitr)

# Remove first-time voters (those who never voted before 2024)
ReturningAllegiantVoters <- AllegiantVoters %>%
  filter(last_voting_method_prior != "No Previous Vote")

# Count how many used each method in 2024
voting_summary <- ReturningAllegiantVoters %>%
  count(votecode59, name = "Count_2024") %>%
  rename(`Voting Method` = votecode59)

# Count how many used each method in their last recorded vote
last_vote_summary <- ReturningAllegiantVoters %>%
  count(last_voting_method_prior, name = "Count_Last") %>%
  rename(`Voting Method` = last_voting_method_prior)

# Merge both summaries
final_voting_table <- full_join(voting_summary, last_vote_summary, by = "Voting Method") %>%
  replace_na(list(Count_2024 = 0, Count_Last = 0))  # Fill NA with 0

# Compute percentages based on returning Allegiant voters
total_returning_allegiant_voters <- nrow(ReturningAllegiantVoters)
final_voting_table <- final_voting_table %>%
  mutate(
    `Percentage of Allegiant Voters (2024)` = round((Count_2024 / total_returning_allegiant_voters) * 100, 2),
    `Percentage of Allegiant Voters (Last Vote)` = round((Count_Last / total_returning_allegiant_voters) * 100, 2)
  )

# Print the formatted table in an easy-to-copy format
final_voting_table %>%
  kable(
    format = "pipe", digits = 2, align = "c",
    col.names = c("Voting Method", "Count 2024", "% Allegiant Voters (2024)", "Count Last Vote", "% Allegiant Voters (Last Vote)")
  )








library(dplyr)

# Ensure we are only looking at returning Allegiant voters
ReturningAllegiantVoters <- AllegiantVoters %>%
  filter(last_voting_method_prior != "No Previous Vote")

# Count the number of voters for each method in 2024 and last vote
voting_summary <- ReturningAllegiantVoters %>%
  count(votecode59, name = "Count_2024") %>%
  rename(`Voting Method` = votecode59)

last_vote_summary <- ReturningAllegiantVoters %>%
  count(last_voting_method_prior, name = "Count_Last") %>%
  rename(`Voting Method` = last_voting_method_prior)

# Merge both counts into a single table
final_voting_table <- full_join(voting_summary, last_vote_summary, by = "Voting Method") %>%
  replace_na(list(Count_2024 = 0, Count_Last = 0))  # Replace NA with 0

# Compute percentages based on returning Allegiant voters
total_returning_allegiant_voters <- nrow(ReturningAllegiantVoters)

final_voting_table <- final_voting_table %>%
  mutate(
    Percentage_2024 = round((Count_2024 / total_returning_allegiant_voters) * 100, 2),
    Percentage_Last = round((Count_Last / total_returning_allegiant_voters) * 100, 2)
  )

# Print the table as a clean, easy-to-copy format
print(final_voting_table, row.names = FALSE)



```

(allegiant as dependent i think)
I'm wide open to your ideas but my initial thinking is number of times voted, party (dummy for Dem, Rep, other with non-partisan as the excluded), age, and dummies for zipcode. When interpreting results checking the zipcode results, if you get effects,  to see which ones are closest to the stadium would be good. I think voting method when last voted could be interesting too, with previous non-voter as the excluded making some sense. 


```{r models}

AllClarkCountyWide <- read_delim("ClarkCo_Nov2024 csv.csv", delim = "\t", col_types = cols(.default = "c"))
AllClarkCountyWide$allegiant <- ifelse(is.na(AllClarkCountyWide$allegiant), 0, 1)
colnames(AllClarkCountyWide)


table(AllClarkCountyWide$allegiant)

#number of times voted

sapply(AllClarkCountyWide[, c("numtimesvoted_beforeNov2024", 
                               "numtimesvoted_beforeFeb2024", 
                               "voted2020_not2022")], function(x) unique(x))

table(AllClarkCountyWide$voted2020_not2022, useNA = "always")
AllClarkCountyWide$voted2020_not2022 <- ifelse(is.na(AllClarkCountyWide$voted2020_not2022), 0, 1)

AllClarkCountyWide$numtimesvoted_beforeNov2024 <- as.numeric(AllClarkCountyWide$numtimesvoted_beforeNov2024)
str(AllClarkCountyWide$numtimesvoted_beforeNov2024)  # Should say "num"

AllClarkCountyWide$numtimesvoted_beforeFeb2024 <- as.numeric(AllClarkCountyWide$numtimesvoted_beforeFeb2024)

table(AllClarkCountyWide$numtimesvoted_beforeNov2024)

model_voting_history <- glm(allegiant ~ numtimesvoted_beforeNov2024 + 
                                          numtimesvoted_beforeFeb2024 + 
                                          voted2020_not2022, 
                            data = AllClarkCountyWide, family = binomial)
summary(model_voting_history)


beforenovmodel_voting_history <- glm(allegiant ~ numtimesvoted_beforeNov2024, 
                            data = AllClarkCountyWide, family = binomial)

summary(beforenovmodel_voting_history)



##party
table(AllClarkCountyWide$party)
AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(
    party_Dem = ifelse(party == "Democrat", 1, 0),
    party_Rep = ifelse(party == "Republican", 1, 0),
    party_Other = ifelse(!party %in% c("Democratic", "Republican", "Non-Partisan"), 1, 0)
  )

table(AllClarkCountyWide$party_Dem, useNA = "always")
table(AllClarkCountyWide$party_Rep)

model_party <- glm(allegiant ~ party_Dem + party_Rep + party_Other, 
                   data = AllClarkCountyWide, 
                   family = binomial)

summary(model_party)


demmodel_party <- glm(allegiant ~ party_Dem, 
                   data = AllClarkCountyWide, 
                   family = binomial)

summary(demmodel_party)




##age
AllClarkCountyWide$ageEDay <- as.numeric(AllClarkCountyWide$ageEDay)

model_age <- glm(allegiant ~ ageEDay, 
                data = AllClarkCountyWide, family = binomial)
summary(model_age)


```
.

Voting Method Count_2024 Count_Last Percentage_2024 Percentage_Last
PP              	2712	1115	          99.82	   41.04
PV               	5	     219	          0.18	   8.06
EV               	0    	628	           0.00	     23.11
MB              	0	    755	            0.00	     27.79


Call:
glm(formula = allegiant ~ numtimesvoted_beforeNov2024 + numtimesvoted_beforeFeb2024 + 
    voted2020_not2022, family = binomial, data = AllClarkCountyWide)

Coefficients:
                            Estimate Std. Error z value Pr(>|z|)    
(Intercept)                 -5.90292    0.02146 -275.01   <2e-16 ***
numtimesvoted_beforeNov2024 -0.62190    0.05286  -11.77   <2e-16 ***
numtimesvoted_beforeFeb2024  0.58771    0.05549   10.59   <2e-16 ***
voted2020_not2022            0.49729    0.03481   14.29   <2e-16 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 58917  on 1639307  degrees of freedom
Residual deviance: 58313  on 1639304  degrees of freedom
AIC: 58321

Number of Fisher Scoring iterations: 9

Call:
glm(formula = allegiant ~ numtimesvoted_beforeNov2024, family = binomial, 
    data = AllClarkCountyWide)

Coefficients:
                             Estimate Std. Error z value Pr(>|z|)    
(Intercept)                 -5.776174   0.018979 -304.34   <2e-16 ***
numtimesvoted_beforeNov2024 -0.070909   0.005105  -13.89   <2e-16 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 58917  on 1639307  degrees of freedom
Residual deviance: 58698  on 1639306  degrees of freedom
AIC: 58702

Number of Fisher Scoring iterations: 9


Call:
glm(formula = allegiant ~ party_Dem + party_Rep + party_Other, 
    family = binomial, data = AllClarkCountyWide)

Coefficients:
            Estimate Std. Error  z value Pr(>|z|)    
(Intercept) -5.96487    0.02566 -232.438   <2e-16 ***
party_Dem    0.07518    0.06526    1.152    0.249    
party_Rep   -0.03455    0.04047   -0.854    0.393    
party_Other -0.03739    0.06471   -0.578    0.563    
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 58535  on 1639275  degrees of freedom
Residual deviance: 58532  on 1639272  degrees of freedom
  (32 observations deleted due to missingness)
AIC: 58540

Number of Fisher Scoring iterations: 8



demmodel_party <- glm(allegiant ~ party_Dem, 
+                    data = AllClarkCountyWide, 
+                    family = binomial)
> summary(demmodel_party)

Call:
glm(formula = allegiant ~ party_Dem, family = binomial, data = AllClarkCountyWide)

Coefficients:
            Estimate Std. Error  z value Pr(>|z|)    
(Intercept) -5.98127    0.01882 -317.778   <2e-16 ***
party_Dem    0.05419    0.03293    1.646   0.0998 .  
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 58535  on 1639275  degrees of freedom
Residual deviance: 58533  on 1639274  degrees of freedom
  (32 observations deleted due to missingness)
AIC: 58537

Number of Fisher Scoring iterations: 8






summary(model_zip)

Call:
glm(formula = allegiant ~ residentialzip, family = binomial, 
    data = AllClarkCountyWide)

Coefficients:
                     Estimate Std. Error z value Pr(>|z|)
(Intercept)          -18.7176  7216.5815  -0.003    0.998
residentialzip84901    0.1516  9727.4812   0.000    1.000
residentialzip89002   12.0405  7216.5815   0.002    0.999
residentialzip89004   13.2839  7216.5816   0.002    0.999
residentialzip89005   10.6386  7216.5815   0.001    0.999
residentialzip89007   12.0120  7216.5816   0.002    0.999
residentialzip89011   12.2527  7216.5815   0.002    0.999
residentialzip89012   12.1202  7216.5815   0.002    0.999
residentialzip89014   12.4527  7216.5815   0.002    0.999
residentialzip89015   12.1938  7216.5815   0.002    0.999
residentialzip89018   11.7813  7216.5816   0.002    0.999
residentialzip89019    0.1516  7218.4020   0.000    1.000
residentialzip89020    0.1516  9727.4793   0.000    1.000
residentialzip89021   10.8361  7216.5816   0.002    0.999
residentialzip89025    0.1516  7219.9650   0.000    1.000
residentialzip89027    9.1816  7216.5816   0.001    0.999
residentialzip89029    0.1516  7217.0144   0.000    1.000
residentialzip89030   12.1412  7216.5815   0.002    0.999
residentialzip89031   12.2702  7216.5815   0.002    0.999
residentialzip89032   12.1020  7216.5815   0.002    0.999
residentialzip89034    0.1516  7217.3140   0.000    1.000
residentialzip89039    0.1516  7230.8076   0.000    1.000
residentialzip89040   10.8948  7216.5816   0.002    0.999
residentialzip89044   12.5917  7216.5815   0.002    0.999
residentialzip89046    0.1516  7222.9728   0.000    1.000
residentialzip89048    0.1516  9727.4777   0.000    1.000
residentialzip89052   12.2567  7216.5815   0.002    0.999
residentialzip89054    0.1516  7283.2669   0.000    1.000
residentialzip89070    0.1516  7692.1943   0.000    1.000
residentialzip89074   12.4763  7216.5815   0.002    0.999
residentialzip89081   12.1932  7216.5815   0.002    0.999
residentialzip89084   11.7621  7216.5815   0.002    0.999
residentialzip89085   12.2726  7216.5815   0.002    0.999
residentialzip89086   11.7790  7216.5815   0.002    0.999
residentialzip89091    0.1516  9727.4792   0.000    1.000
residentialzip89101   12.0582  7216.5815   0.002    0.999
residentialzip89102   13.2404  7216.5815   0.002    0.999
residentialzip89103   14.6362  7216.5815   0.002    0.998
residentialzip89104   12.2383  7216.5815   0.002    0.999
residentialzip89105    0.1516  8140.0647   0.000    1.000
residentialzip89106   12.3577  7216.5815   0.002    0.999
residentialzip89107   12.8381  7216.5815   0.002    0.999
residentialzip89108   12.3553  7216.5815   0.002    0.999
residentialzip89109   13.1318  7216.5815   0.002    0.999
residentialzip89110   12.3031  7216.5815   0.002    0.999
residentialzip89112    0.1516  8564.5466   0.000    1.000
residentialzip89113   13.5174  7216.5815   0.002    0.999
residentialzip89114    0.1516  9727.4793   0.000    1.000
residentialzip89115   12.1332  7216.5815   0.002    0.999
residentialzip89117   12.3763  7216.5815   0.002    0.999
residentialzip89118   15.1965  7216.5815   0.002    0.998
residentialzip89119   13.0494  7216.5815   0.002    0.999
residentialzip89120   12.6593  7216.5815   0.002    0.999
residentialzip89121   12.4630  7216.5815   0.002    0.999
residentialzip89122   12.2761  7216.5815   0.002    0.999
residentialzip89123   13.0917  7216.5815   0.002    0.999
residentialzip89124    0.1516  7221.4281   0.000    1.000
residentialzip89125    0.1516  9727.4791   0.000    1.000
residentialzip89128   12.3125  7216.5815   0.002    0.999
residentialzip89129   12.2948  7216.5815   0.002    0.999
residentialzip89130   12.2804  7216.5815   0.002    0.999
residentialzip89131   11.7723  7216.5815   0.002    0.999
residentialzip89134   11.6700  7216.5815   0.002    0.999
residentialzip89135   12.0059  7216.5815   0.002    0.999
residentialzip89138   11.8562  7216.5815   0.002    0.999
residentialzip89139   13.4813  7216.5815   0.002    0.999
residentialzip89141   13.1730  7216.5815   0.002    0.999
residentialzip89142   12.6034  7216.5815   0.002    0.999
residentialzip89143   11.7345  7216.5815   0.002    0.999
residentialzip89144   11.7589  7216.5815   0.002    0.999
residentialzip89145   12.2432  7216.5815   0.002    0.999
residentialzip89146   12.8550  7216.5815   0.002    0.999
residentialzip89147   13.2965  7216.5815   0.002    0.999
residentialzip89148   12.9390  7216.5815   0.002    0.999
residentialzip89149   12.1087  7216.5815   0.002    0.999
residentialzip89156   12.3336  7216.5815   0.002    0.999
residentialzip89158   15.6964  7216.5815   0.002    0.998
residentialzip89161   12.9277  7216.5816   0.002    0.999
residentialzip89164    0.1516  8564.5458   0.000    1.000
residentialzip89166   12.1247  7216.5815   0.002    0.999
residentialzip89169   13.3272  7216.5815   0.002    0.999
residentialzip89170    0.1516  9727.4791   0.000    1.000
residentialzip89178   12.7451  7216.5815   0.002    0.999
residentialzip89179   12.5437  7216.5815   0.002    0.999
residentialzip89181    0.1516  9727.4806   0.000    1.000
residentialzip89183   12.8610  7216.5815   0.002    0.999
residentialzip89191    0.1516  7692.1940   0.000    1.000
residentialzip89706    0.1516  9727.4799   0.000    1.000
residentialzip89886    0.1516  9727.4787   0.000    1.000
residentialzip95808    0.1516  9727.4819   0.000    1.000

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 58211  on 1624927  degrees of freedom
Residual deviance: 54642  on 1624838  degrees of freedom
  (14380 observations deleted due to missingness)
AIC: 54822

Number of Fisher Scoring iterations: 17





```{r age and voting method model}






##age
model_age <- glm(allegiant ~ ageEDay, 
                data = AllClarkCountyWide, family = binomial)
summary(model_age)

install.packages("biglm")
library(biglm)

model_age_big <- bigglm(allegiant ~ ageEDay, data = AllClarkCountyWide, family = binomial())
summary(model_age_big)








#vote method
colnames(AllClarkCountyWide)

table(AllClarkCountyWide$votecode41)

# Select relevant columns
vote_cols <- paste0("votecode", 41:58)

# Step 1: Find the last vote method for each person before Nov 2024
filtered_data <- AllClarkCountyWide %>%
  filter(numtimesvoted_beforeNov2024 > 0) %>%
  rowwise() %>%
  mutate(last_vote_method = last(na.omit(c_across(all_of(vote_cols))))) %>%
  ungroup()

table(filtered_data$last_vote_method, useNA = "ifany")


# Step 2: Create Binary Variables for the Last Voting Method
filtered_data <- filtered_data %>%
  mutate(
    last_voted_EV = ifelse(last_vote_method == "EV", 1, 0),
    last_voted_MB = ifelse(last_vote_method == "MB", 1, 0),
    last_voted_PP = ifelse(last_vote_method == "PP", 1, 0),
    last_voted_PV = ifelse(last_vote_method == "PV", 1, 0)
  )

# Check results
table(filtered_data$last_vote_method)
table(filtered_data$last_voted_EV)
table(filtered_data$last_voted_MB)
table(filtered_data$last_voted_PP)
table(filtered_data$last_voted_PV)

table(filtered_data$last_voted_EV, filtered_data$allegiant)
table(filtered_data$last_voted_MB, filtered_data$allegiant)
table(filtered_data$last_voted_PP, filtered_data$allegiant)
table(filtered_data$last_voted_PV, filtered_data$allegiant)

# View structure
glimpse(filtered_data)

glimpse(filtered_data$allegiant)
filtered_data <- filtered_data %>%
  mutate(allegiant = as.numeric(allegiant))  # Convert character to numeric


filtered_data <- filtered_data %>%
  mutate(allegiant = ifelse(is.na(allegiant), 0, 1))  # Convert NA to 0

# Confirm the fix
table(filtered_data$allegiant, useNA = "ifany")  # Should now have only 1s and 0s


# Logistic regression with multiple binary predictors
lastvotemethodmodel <- glm(allegiant ~ last_voted_EV + last_voted_MB + last_voted_PP, 
                   data = filtered_data, 
                   family = binomial(link = "logit"))

# View summary of the model
summary(lastvotemethodmodel)


# Logistic regression with multiple binary predictors
evmodel <- glm(allegiant ~ last_voted_EV, 
                   data = filtered_data, 
                   family = binomial(link = "logit"))

# View summary of the model
summary(evmodel)

mbmodel <- glm(allegiant ~ last_voted_MB, 
                   data = filtered_data, 
                   family = binomial(link = "logit"))

# View summary of the model
summary(mbmodel)


ppmodel <- glm(allegiant ~ last_voted_PP, 
                   data = filtered_data, 
                   family = binomial(link = "logit"))

# View summary of the model
summary(ppmodel)



table(filtered_data$allegiant, useNA = "ifany")
prop.table(table(filtered_data$allegiant))


table(filtered_data$allegiant, useNA = "ifany")


```

Call:
glm(formula = allegiant ~ ageEDay, family = binomial, data = AllClarkCountyWide)

Coefficients:
              Estimate Std. Error z value Pr(>|z|)    
(Intercept) -4.9903112  0.0402766 -123.90   <2e-16 ***
ageEDay     -0.0222427  0.0009208  -24.16   <2e-16 ***
---
Signif. codes:  
0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 58535  on 1639275  degrees of freedom
Residual deviance: 57903  on 1639274  degrees of freedom
  (32 observations deleted due to missingness)
AIC: 57907

Number of Fisher Scoring iterations: 9


Call:
glm(formula = allegiant ~ last_voted_EV + last_voted_MB + last_voted_PP + 
    last_voted_PV, family = binomial(link = "logit"), data = filtered_data)

Coefficients:
              Estimate Std. Error z value Pr(>|z|)
(Intercept)    -14.566     76.259  -0.191    0.849
last_voted_EV    8.525     76.259   0.112    0.911
last_voted_MB    8.066     76.259   0.106    0.916
last_voted_PP    9.208     76.259   0.121    0.904
last_voted_PV    9.494     76.259   0.124    0.901

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 37748  on 1040515  degrees of freedom
Residual deviance: 37015  on 1040511  degrees of freedom
AIC: 37025

Number of Fisher Scoring iterations: 13



Call:
glm(formula = allegiant ~ last_voted_EV + last_voted_MB + last_voted_PP, 
    family = binomial(link = "logit"), data = filtered_data)

Coefficients:
              Estimate Std. Error z value Pr(>|z|)    
(Intercept)   -5.07634    0.06778 -74.890  < 2e-16 ***
last_voted_EV -0.96500    0.07868 -12.265  < 2e-16 ***
last_voted_MB -1.42328    0.07695 -18.496  < 2e-16 ***
last_voted_PP -0.28150    0.07413  -3.797 0.000146 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 37748  on 1040515  degrees of freedom
Residual deviance: 37017  on 1040512  degrees of freedom
AIC: 37025

Number of Fisher Scoring iterations: 9






Call:
glm(formula = allegiant ~ last_voted_EV, family = binomial(link = "logit"), 
    data = filtered_data)

Coefficients:
              Estimate Std. Error  z value Pr(>|z|)    
(Intercept)   -5.91457    0.02191 -269.990  < 2e-16 ***
last_voted_EV -0.12678    0.04556   -2.783  0.00539 ** 
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 37748  on 1040515  degrees of freedom
Residual deviance: 37740  on 1040514  degrees of freedom
AIC: 37744

Number of Fisher Scoring iterations: 8

Call:
glm(formula = allegiant ~ last_voted_MB, family = binomial(link = "logit"), 
    data = filtered_data)

Coefficients:
              Estimate Std. Error z value Pr(>|z|)    
(Intercept)   -5.60981    0.02262 -248.03   <2e-16 ***
last_voted_MB -0.88982    0.04287  -20.75   <2e-16 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 37748  on 1040515  degrees of freedom
Residual deviance: 37270  on 1040514  degrees of freedom
AIC: 37274

Number of Fisher Scoring iterations: 9

Call:
glm(formula = allegiant ~ last_voted_PP, family = binomial(link = "logit"), 
    data = filtered_data)

Coefficients:
              Estimate Std. Error z value Pr(>|z|)    
(Intercept)   -6.21476    0.02501 -248.50   <2e-16 ***
last_voted_PP  0.85692    0.03907   21.93   <2e-16 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 37748  on 1040515  degrees of freedom
Residual deviance: 37303  on 1040514  degrees of freedom
AIC: 37307

Number of Fisher Scoring iterations: 9


```{r zipcode models}


##zipcode
table(AllClarkCountyWide$residentialzip)


AllClarkCountyWide <- AllClarkCountyWide %>%
  mutate(across(.cols = residentialzip, 
                .fns = ~ as.factor(.))) %>%
  mutate(across(.cols = residentialzip, 
                .fns = ~ ifelse(. == residentialzip, 1, 0), 
                .names = "zip_{.}"))


model_zip <- glm(allegiant ~ . - residentialzip, 
                 data = AllClarkCountyWide, 
                 family = binomial(link = "logit"))

summary(model_zip)


AllClarkCountyWide$residentialzip <- as.factor(AllClarkCountyWide$residentialzip)


model_zip <- glm(allegiant ~ residentialzip, 
                 data = AllClarkCountyWide, 
                 family = binomial)

summary(model_zip)


significant_zips <- summary(model_zip)$coefficients %>%
  as.data.frame() %>%
  rownames_to_column("variable") %>%
  filter(`Pr(>|z|)` < 0.05 & grepl("residentialzip", variable))

print(significant_zips)




zip_codes <- unique(AllClarkCountyWide$residentialzip)  # Get all unique zip codes
zip_results <- data.frame(ZipCode = character(), Estimate = numeric(), PValue = numeric())

for (zip in zip_codes) {
  model <- glm(allegiant ~ (residentialzip == zip), 
               data = AllClarkCountyWide, 
               family = binomial)
  
  summary_model <- summary(model)
  estimate <- summary_model$coefficients[2, 1]  # Coefficient for the zip code
  p_value <- summary_model$coefficients[2, 4]   # P-value for the zip code
  
  zip_results <- rbind(zip_results, data.frame(ZipCode = zip, Estimate = estimate, PValue = p_value))
}

# View only significant zip codes
significant_zips <- zip_results %>% filter(PValue < 0.05)
print(significant_zips)






# Count number of 0s and 1s for allegiant in each zip code
zip_counts <- AllClarkCountyWide %>%
  group_by(residentialzip) %>%
  summarize(count_0 = sum(allegiant == 0, na.rm = TRUE),
            count_1 = sum(allegiant == 1, na.rm = TRUE),
            total = n()) %>%
  ungroup()

# Keep only zip codes that have at least 10 votes and both 0s and 1s
valid_zips <- zip_counts %>%
  filter(count_0 > 0 & count_1 > 0 & total >= 10) %>%
  pull(residentialzip)

zip_results <- data.frame(ZipCode = character(), Estimate = numeric(), PValue = numeric())

for (zip in valid_zips) {
  model <- glm(allegiant ~ I(residentialzip == zip), 
               data = AllClarkCountyWide, 
               family = binomial)
  
  summary_model <- summary(model)
  estimate <- summary_model$coefficients[2, 1]  # Coefficient for the zip code
  p_value <- summary_model$coefficients[2, 4]   # P-value for the zip code
  
  zip_results <- rbind(zip_results, data.frame(ZipCode = zip, Estimate = estimate, PValue = p_value))
}

# View only significant zip codes
significant_zips <- zip_results %>% filter(PValue < 0.1)
print(significant_zips)





# Count number of 0s and 1s for allegiant in each zip code
zip_counts <- AllClarkCountyWide %>%
  group_by(residentialzip) %>%
  summarize(count_0 = sum(allegiant == 0, na.rm = TRUE),
            count_1 = sum(allegiant == 1, na.rm = TRUE),
            total = n()) %>%
  ungroup()

# Print zip codes where there are only 0s or only 1s (these cause glm() errors)
zip_counts %>%
  filter(count_0 == 0 | count_1 == 0) %>%
  print()

valid_zips <- zip_counts %>%
  filter(count_0 > 0 & count_1 > 0 & total >= 10) %>%
  pull(residentialzip)

length(valid_zips)  # Check how many zip codes are left

zip_results <- data.frame(ZipCode = character(), Estimate = numeric(), PValue = numeric())

for (zip in valid_zips) {
  tryCatch({
    model <- glm(allegiant ~ I(residentialzip == zip), 
                 data = AllClarkCountyWide, 
                 family = binomial)
    
    summary_model <- summary(model)
    estimate <- summary_model$coefficients[2, 1]  # Coefficient for the zip code
    p_value <- summary_model$coefficients[2, 4]   # P-value for the zip code
    
    zip_results <- rbind(zip_results, data.frame(ZipCode = zip, Estimate = estimate, PValue = p_value))
  }, error = function(e) {
    message("Skipping zip code ", zip, " due to an error.")
  })
}


significant_zips <- zip_results %>% filter(PValue < 0.05)
print(significant_zips)


write.csv(significant_zips, "significant_zipcodes.csv", row.names = FALSE)

significant_zips <- read_csv("significant_zipcodes.csv") 


View(significant_zips)  # Opens a scrollable data viewer in RStudio

print(significant_zips$ZipCode)







library(ggplot2)
library(dplyr)

# Create a summary table
significant_zips %>%
  arrange(PValue) %>%
  select(ZipCode, Estimate, PValue) %>%
  head(20)  # Show the top 20 significant zip codes













install.packages("sf")
library(sf)
setwd("C:/Users/izzoe/Documents/GitHub/CDCE/NVVoters")

faces <- st_read("C:/Users/izzoe/Documents/GitHub/CDCE/NVVoters/tl_2023_32003_faces/tl_2023_32003_faces.shp")

file.exists("C:/Users/izzoe/Documents/GitHub/CDCE/NVVoters/tl_2023_32003_faces/tl_2023_32003_faces.shp")

# View column names
colnames(faces)

# Check first few rows
head(faces)

# Check the geometry type
st_geometry_type(faces)

library(sf)
library(dplyr)

# **1. Extract ZIP Code areas**
zip_areas <- faces %>% 
  select(ZCTA5CE20, geometry) %>% 
  filter(!is.na(ZCTA5CE20))  # Remove any missing ZIP codes

# Convert ZIP codes to character type
zip_areas$ZCTA5CE20 <- as.character(zip_areas$ZCTA5CE20)

# **2. Compute centroids for each ZIP Code area**
zip_centroids <- zip_areas %>%
  mutate(geometry = st_centroid(geometry)) %>%  # Compute centroids directly
  st_as_sf()  # Ensure it's an sf object

# **3. Define Allegiant Stadium's location as a single-point geometry**
allegiant_stadium_geom <- st_sfc(st_point(c(-115.183, 36.090)), crs = st_crs(zip_centroids))

# **4. Compute distance from each ZIP centroid to Allegiant Stadium**
zip_centroids$distance_to_stadium <- as.numeric(st_distance(zip_centroids, 
                                                            allegiant_stadium_geom)) / 1609.34  # Convert meters to miles

# **5. Verify the results**
head(zip_centroids$distance_to_stadium)
summary(zip_centroids$distance_to_stadium)






# Check structure of zip_centroids
print(zip_centroids)
print(class(zip_centroids))  # Should be 'sf' or 'data.frame'
print(nrow(zip_centroids))   # Should be >1

# Check structure of allegiant_stadium_geom
print(allegiant_stadium_geom)
print(class(allegiant_stadium_geom))  # Should be 'sfc' or 'sf'
print(length(allegiant_stadium_geom))  # Should be 1

# Test a single zip centroid against Allegiant Stadium
test_distance <- st_distance(zip_centroids[1, ], allegiant_stadium_geom)

print(test_distance)

allegiant_stadium_geom <- st_sfc(st_point(c(-115.183, 36.090)), crs = st_crs(zip_centroids))

# Re-run test
st_distance(zip_centroids[1, ], allegiant_stadium_geom)

zip_centroids$distance_to_stadium <- as.numeric(st_distance(zip_centroids, allegiant_stadium_geom)) / 1609.34

# Check first few distance values
head(zip_centroids$distance_to_stadium)

# Summary of distance values (to make sure they look reasonable)
summary(zip_centroids$distance_to_stadium)









#ZipMapClarkCountyWide <- AllClarkCountyWide %>%
#  left_join(zip_centroids %>% st_drop_geometry(), 
#            by = c("residentialzip" = "ZCTA5CE20"))


# Drop unnecessary columns before merging
zip_distances <- zip_centroids %>%
  st_drop_geometry() %>%
  select(ZCTA5CE20, distance_to_stadium)  # Keep only ZIP code and distance

# Check memory usage of new object
print(object.size(zip_distances), units = "GB")


library(data.table)

# Convert to data.table format for efficient merging
setDT(AllClarkCountyWide)
setDT(zip_distances)

# Merge using data.table (faster than dplyr)
ZipMapClarkCountyWide <- merge(AllClarkCountyWide, zip_distances, 
                            by.x = "residentialzip", 
                            by.y = "ZCTA5CE20", 
                            all.x = TRUE)

# Convert back to data.frame if needed
setDF(AllClarkCountyWide)





zip_dupes <- zip_centroids %>%
  st_drop_geometry() %>%
  count(ZCTA5CE20) %>%
  filter(n > 1)

print(zip_dupes)


zip_centroids <- zip_centroids %>%
  st_drop_geometry() %>%
  group_by(ZCTA5CE20) %>%
  summarize(distance_to_stadium = mean(distance_to_stadium, na.rm = TRUE)) %>%
  ungroup()



setDT(AllClarkCountyWide)
setDT(zip_centroids)

# Merge using data.table with optimized memory
ZipMapClarkCountyWide <- merge(AllClarkCountyWide, zip_centroids, 
                               by.x = "residentialzip", 
                               by.y = "ZCTA5CE20", 
                               all.x = TRUE)



summary(ZipMapClarkCountyWide$distance_to_stadium)
head(ZipMapClarkCountyWide)



str(ZipMapClarkCountyWide)
ZipMapClarkCountyWide$allegiant <- as.numeric(as.character(ZipMapClarkCountyWide$allegiant))


ZipMapClarkCountyWide$allegiant[is.na(ZipMapClarkCountyWide$allegiant)] <- 0


table(ZipMapClarkCountyWide$allegiant)
prop.table(table(ZipMapClarkCountyWide$allegiant))  # Check proportions








model_distance <- glm(allegiant ~ distance_to_stadium, 
                      data = ZipMapClarkCountyWide, 
                      family = binomial)

summary(model_distance)


library(ggplot2)

ggplot(ZipMapClarkCountyWide, aes(x = distance_to_stadium, y = allegiant)) +
  geom_point(alpha = 0.3) +
  geom_smooth(method = "glm", method.args = list(family = binomial), color = "red") +
  labs(title = "Probability of Voting at Allegiant Stadium by Distance",
       x = "Distance to Allegiant Stadium (miles)",
       y = "Probability of Voting") +
  theme_minimal()






ZipVoteSummary <- ZipMapClarkCountyWide %>%
  group_by(residentialzip) %>%
  summarize(
    total_voters = n(),
    allegiant_voters = sum(allegiant),
    percent_allegiant = allegiant_voters / total_voters * 100,
    avg_distance = mean(distance_to_stadium, na.rm = TRUE)
  ) %>%
  ungroup()




ggplot(ZipVoteSummary, aes(x = avg_distance, y = percent_allegiant)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", color = "red") +  # Linear trendline
  labs(
    title = "Percentage of Voters Using Allegiant Stadium by Distance",
    x = "Average Distance to Allegiant Stadium (miles)",
    y = "Percentage of Voters at Allegiant Stadium"
  ) +
  theme_minimal()

ggplot(ZipVoteSummary, aes(x = avg_distance, y = percent_allegiant, label = residentialzip)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", color = "red") +  # Linear trendline
  geom_text(vjust = -0.5, size = 3, check_overlap = TRUE) +  # Add ZIP code labels
  labs(
    title = "Percentage of Voters Using Allegiant Stadium by Distance",
    x = "Average Distance to Allegiant Stadium (miles)",
    y = "Percentage of Voters at Allegiant Stadium"
  ) +
  theme_minimal()







ggplot(ZipVoteSummary, aes(x = avg_distance, y = percent_allegiant)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "loess", color = "blue") +  # Smooth nonlinear trend
  labs(
    title = "Percentage of Voters Using Allegiant Stadium by Distance",
    x = "Average Distance to Allegiant Stadium (miles)",
    y = "Percentage of Voters at Allegiant Stadium"
  ) +
  theme_minimal()




ggplot(ZipVoteSummary, aes(x = avg_distance, y = percent_allegiant, label = residentialzip)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "loess", color = "blue") +  # Nonlinear smoother
  geom_text(vjust = -0.5, size = 3, check_overlap = TRUE) +  # Add ZIP code labels
  labs(
    title = "Percentage of Voters Using Allegiant Stadium by Distance",
    x = "Average Distance to Allegiant Stadium (miles)",
    y = "Percentage of Voters at Allegiant Stadium"
  ) +
  theme_minimal()


ggplot(ZipVoteSummary, aes(x = avg_distance, y = percent_allegiant, label = residentialzip)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "loess", color = "blue", span = 0.6) +  # Slightly wider smoothing window
  geom_text(vjust = -0.5, size = 3, check_overlap = TRUE) +  
  labs(
    title = "Percentage of Voters Using Allegiant Stadium by Distance",
    x = "Average Distance to Allegiant Stadium (miles)",
    y = "Percentage of Voters at Allegiant Stadium"
  ) +
  theme_minimal()



model_logit <- glm(cbind(allegiant_voters, total_voters - allegiant_voters) ~ avg_distance, 
                   family = binomial, data = ZipVoteSummary)

ggplot(ZipVoteSummary, aes(x = avg_distance, y = percent_allegiant / 100)) +
  geom_point(alpha = 0.5) +
  stat_smooth(method = "glm", method.args = list(family = "binomial"), color = "red") +
  geom_text(vjust = -0.5, size = 3, check_overlap = TRUE) +
  labs(
    title = "Logistic Model of Allegiant Stadium Voting by Distance",
    x = "Average Distance to Allegiant Stadium (miles)",
    y = "Proportion of Voters at Allegiant Stadium"
  ) +
  theme_minimal()






distance_percentage <- lm(percent_allegiant ~ avg_distance, data = ZipVoteSummary)
summary(distance_percentage)



```
Call:
glm(formula = allegiant ~ distance_to_stadium, family = binomial, 
    data = ZipMapClarkCountyWide)

Coefficients:
                    Estimate Std. Error z value Pr(>|z|)    
(Intercept)         -4.33889    0.03754 -115.57   <2e-16 ***
distance_to_stadium -0.21072    0.00524  -40.22   <2e-16 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 58211  on 1624908  degrees of freedom
Residual deviance: 56149  on 1624907  degrees of freedom
  (14399 observations deleted due to missingness)
AIC: 56153

Number of Fisher Scoring iterations: 10



Linear

Call:
lm(formula = percent_allegiant ~ avg_distance, data = ZipVoteSummary)

Residuals:
    Min      1Q  Median      3Q     Max 
-0.3365 -0.2038 -0.1618  0.0071  4.2160 

Coefficients:
              Estimate Std. Error t value Pr(>|t|)    
(Intercept)   0.440106   0.096073   4.581 1.87e-05 ***
avg_distance -0.009085   0.003849  -2.361   0.0209 *  
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.6155 on 73 degrees of freedom
  (16 observations deleted due to missingness)
Multiple R-squared:  0.07093,	Adjusted R-squared:  0.0582 
F-statistic: 5.573 on 1 and 73 DF,  p-value: 0.02091



```{r first time voters}

colnames(AllClarkCountyWide)


# Filter first-time voters in November 2024
first_time_voters <- AllClarkCountyWide %>%
  filter(numtimesvoted_beforeNov2024 == 0)

# Create subsets for those who voted at Allegiant and those who didn't
first_time_voters_allegiant <- first_time_voters %>%
  filter(allegiant == 1)  # Assuming 1 means voted at Allegiant

first_time_voters_not_allegiant <- first_time_voters %>%
  filter(allegiant == 0)  # Assuming 0 means did not vote at Allegiant

# Check the counts
nrow(first_time_voters)
nrow(first_time_voters_allegiant)
nrow(first_time_voters_not_allegiant)

# Save subsets if needed
write.csv(first_time_voters, "first_time_voters_Nov2024.csv", row.names = FALSE)
write.csv(first_time_voters_allegiant, "first_time_voters_Allegiant.csv", row.names = FALSE)
write.csv(first_time_voters_not_allegiant, "first_time_voters_Not_Allegiant.csv", row.names = FALSE)




####Party 

# Create dummy variables correctly
first_time_voters <- first_time_voters %>%
  mutate(
    party_Dem = ifelse(party == "Democrat", 1, 0),
    party_Rep = ifelse(party == "Republican", 1, 0),
    party_Other = ifelse(!(party %in% c("Democratic", "Republican", "Non-Partisan")), 1, 0) # Exclude Dems & Reps properly
  )

# Check table outputs again
table(first_time_voters$party, first_time_voters$party_Dem)
table(first_time_voters$party, first_time_voters$party_Rep)
table(first_time_voters$party, first_time_voters$party_Other)






partyfirsttime <- glm(allegiant ~ party_Dem + party_Rep + party_Other, 
                      data = first_time_voters, 
                      family = binomial)

# Model Summary
summary(partyfirsttime)



####age
first_time_voters$ageEDay <- as.numeric(first_time_voters$ageEDay)

age_model <- glm(allegiant ~ ageEDay, 
                 data = first_time_voters, 
                 family = binomial)

# Model Summary
summary(age_model)


View(AllClarkCountyWide)
```
First time voter party
Call:
glm(formula = allegiant ~ party_Dem + party_Rep + party_Other, 
    family = binomial, data = first_time_voters)

Coefficients:
            Estimate Std. Error  z value Pr(>|z|)    
(Intercept) -6.16868    0.03653 -168.872   <2e-16 ***
party_Dem    0.14358    0.12108    1.186    0.236    
party_Rep    0.65795    0.06483   10.149   <2e-16 ***
party_Other  0.07885    0.11223    0.703    0.482    
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 20785  on 598759  degrees of freedom
Residual deviance: 20689  on 598756  degrees of freedom
  (32 observations deleted due to missingness)
AIC: 20697

Number of Fisher Scoring iterations: 9





summary(age_model)

Call:
glm(formula = allegiant ~ ageEDay, family = binomial, data = first_time_voters)

Coefficients:
             Estimate Std. Error z value Pr(>|z|)    
(Intercept) -5.563021   0.066272 -83.943  < 2e-16 ***
ageEDay     -0.011577   0.001691  -6.844 7.69e-12 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 20785  on 598759  degrees of freedom
Residual deviance: 20735  on 598758  degrees of freedom
  (32 observations deleted due to missingness)
AIC: 20739

Number of Fisher Scoring iterations: 9

